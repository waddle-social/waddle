# Kustomization for Gateway API Ingress
# ======================================
#
# This Kustomization prepares Gateway API resources for Flux GitOps deployment.
# It defines the resource ordering and namespace configuration.
#
# =============================================================================
# MANUAL INSTALLATION (PHASE 10)
# =============================================================================
#
# For manual installation, follow these steps in order:
#
# 1. Verify prerequisites:
#    kubectl get gatewayclass cilium        # Cilium GatewayClass exists
#    kubectl get clusterissuer              # cert-manager ClusterIssuers exist
#
# 2. Update configuration:
#    - Edit gateway.yaml: Replace 'waddle.social' with your domain
#    - Edit certificate.yaml: Update dnsNames with your domain(s)
#
# 3. Create namespace:
#    kubectl apply -f namespace.yaml
#
# 4. Deploy Gateway and Certificate:
#    kubectl apply -f gateway.yaml
#    kubectl apply -f certificate.yaml
#
# 5. Get LoadBalancer IP:
#    kubectl get gateway gateway -n gateway-ingress -o jsonpath='{.status.addresses[0].value}'
#
# 6. Configure DNS:
#    - Create A record in Cloudflare: waddle.social → <LoadBalancer-IP>
#    - Create wildcard A record: *.waddle.social → <LoadBalancer-IP>
#    - Wait for DNS propagation (check with: dig waddle.social)
#
# 7. Verify certificate issuance:
#    kubectl get certificate -n gateway-ingress
#    kubectl describe certificate gateway-tls -n gateway-ingress
#
# 8. Test HTTPS access:
#    curl -v https://waddle.social
#
# =============================================================================
# FLUX DEPLOYMENT (PHASE 8+)
# =============================================================================
#
# Flux Kustomization is defined in clusters/production/infrastructure/gateway.yaml
# It references this path and applies resources with proper dependencies.
#
# Resource ordering ensured by Flux dependsOn:
# 1. Cilium (provides GatewayClass)
# 2. cert-manager (provides ClusterIssuers)
# 3. Gateway API (this Kustomization)
#
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Gateway runs in dedicated namespace
namespace: gateway-ingress

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: gateway-api
  app.kubernetes.io/managed-by: kustomize

# Resources in this directory (order matters for dependencies)
resources:
  - namespace.yaml
  - gateway.yaml
  - certificate.yaml

# =============================================================================
# DEPENDENCY NOTES
# =============================================================================
#
# Resource ordering for Gateway API deployment:
#
# 1. Prerequisites (must exist before Gateway):
#    - Cilium CNI with Gateway API enabled (Phase 6)
#      - GatewayClass 'cilium' must exist
#      - kubectl get gatewayclass cilium
#    - cert-manager with ClusterIssuers (Phase 9)
#      - ClusterIssuer 'letsencrypt-production' must exist
#      - kubectl get clusterissuer letsencrypt-production
#    - Cloudflare DNS:
#      - A record pointing domain to LoadBalancer IP
#      - API token for DNS01 challenges (already configured in Phase 9)
#
# 2. Gateway Resources:
#    - Namespace 'gateway-ingress'
#    - Gateway 'gateway' with HTTP/HTTPS listeners
#    - Certificate 'gateway-tls' for TLS termination
#
# 3. Application Resources (separate from this Kustomization):
#    - HTTPRoutes in application namespaces
#    - ReferenceGrants for cross-namespace routing
#    - Backend Services
#
# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# 1. Namespace Isolation:
#    - Gateway resources isolated in 'gateway-ingress' namespace
#    - RBAC can restrict who can create/modify Gateway
#    - HTTPRoutes in other namespaces require ReferenceGrant
#
# 2. TLS Security:
#    - TLS termination at Gateway (not passthrough)
#    - Certificate auto-rotated by cert-manager (60 days before expiry)
#    - Private key stored in Kubernetes Secret
#
# 3. Cross-Namespace Routing:
#    - Gateway allows routes from 'All' namespaces
#    - Production should use ReferenceGrant for explicit permissions
#    - Consider 'Selector' for namespace-based access control
#
# 4. Rate Limiting:
#    - Configure rate limiting via Cilium Network Policies
#    - Or use HTTPRoute filters (when supported)
#
# =============================================================================

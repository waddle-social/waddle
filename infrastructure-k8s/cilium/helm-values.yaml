# Cilium CNI Helm Values for Talos Kubernetes
# This file configures Cilium v1.18.4 as the CNI for a Talos-based Kubernetes cluster
# with Gateway API support, kube-proxy replacement, and Hubble observability.
#
# Usage:
#   helm repo add cilium https://helm.cilium.io/
#   helm repo update
#   helm install cilium cilium/cilium \
#     --version 1.18.4 \
#     --namespace kube-system \
#     --values helm-values.yaml
#
# IMPORTANT: Install Gateway API CRDs BEFORE deploying Cilium:
#   kubectl apply --server-side -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml
#
# Note: Flux will automate this deployment in Phase 7.

# =============================================================================
# TALOS-SPECIFIC KUBERNETES API CONFIGURATION
# =============================================================================
# Talos uses KubePrism (localhost:7445) as the Kubernetes API endpoint.
# This is critical for Cilium to communicate with the API server.

k8sServiceHost: localhost
k8sServicePort: 7445

# =============================================================================
# KUBE-PROXY REPLACEMENT
# =============================================================================
# Cilium completely replaces kube-proxy using eBPF for better performance.
# This is the recommended mode for Talos clusters.

kubeProxyReplacement: true

# BPF kube-proxy replacement requires the node to have kernel 4.19+
# Talos v1.11.5 ships with a compatible kernel.

# =============================================================================
# IPAM CONFIGURATION
# =============================================================================
# Use Kubernetes host-scope IPAM for pod IP allocation.
# Pod IPs are allocated from the configured cluster network (10.244.0.0/16).

ipam:
  mode: kubernetes

# =============================================================================
# ROUTING CONFIGURATION
# =============================================================================
# Native routing mode provides better performance than tunneling.
# The CIDR must match TALOS_CLUSTER_NETWORK from .env configuration.

ipv4NativeRoutingCIDR: 10.244.0.0/16

# Disable tunneling (VXLAN/Geneve) for direct routing
tunnel: disabled

# Automatically install routes to other nodes
autoDirectNodeRoutes: true

# =============================================================================
# GATEWAY API CONFIGURATION
# =============================================================================
# Enable Cilium's Gateway API controller for ingress traffic management.
# Requires Gateway API CRDs to be installed first (see gateway-api-crds.yaml).

gatewayAPI:
  enabled: true
  # Enable ALPN (Application-Layer Protocol Negotiation) support
  enableAlpn: true
  # Enable AppProtocol field support in Kubernetes services
  enableAppProtocol: true

# =============================================================================
# CILIUM OPERATOR CONFIGURATION
# =============================================================================
# The Cilium Operator manages cluster-wide Cilium resources.
# Single replica is sufficient for a 3-node cluster.

operator:
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# =============================================================================
# HUBBLE OBSERVABILITY
# =============================================================================
# Hubble provides network visibility and monitoring.
# Enable for debugging network issues and observing traffic flows.

hubble:
  enabled: true
  
  # Hubble Relay aggregates flows from all nodes
  relay:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
  
  # Hubble UI provides a web interface for network visualization
  ui:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
  
  # Collect and export flow metrics for Prometheus
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - port-distribution
      - icmp
      - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction

# =============================================================================
# CILIUM AGENT CONFIGURATION
# =============================================================================
# The Cilium agent runs on every node as a DaemonSet.

resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# =============================================================================
# TALOS SECURITY CONTEXT (CRITICAL)
# =============================================================================
# Talos runs containers with restricted privileges. These capabilities are
# required for Cilium to function properly without kernel module loading.
#
# DO NOT REMOVE THESE CAPABILITIES - Cilium will fail to start.

securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# =============================================================================
# BPF CONFIGURATION
# =============================================================================
# eBPF (extended Berkeley Packet Filter) is Cilium's dataplane technology.

bpf:
  # Enable socket-based load balancing for improved performance
  lbExternalClusterIP: true
  # Path to BPF filesystem mount point
  root: /sys/fs/bpf
  # Auto-mount BPF filesystem if not already mounted
  autoMount:
    enabled: true

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================
# Configuration for Kubernetes service load balancing.

loadBalancer:
  # Use DSR (Direct Server Return) for external traffic
  mode: snat

# =============================================================================
# PROMETHEUS METRICS
# =============================================================================
# Enable Prometheus metrics for monitoring Cilium health and performance.

prometheus:
  enabled: true
  serviceMonitor:
    enabled: false  # Enable if you have Prometheus Operator installed

# =============================================================================
# ADDITIONAL CONFIGURATION
# =============================================================================

# Enable debug logging for troubleshooting (set to false for production)
debug:
  enabled: false

# Cluster name (for multi-cluster setups)
cluster:
  name: waddle-cluster

# Note: The following Cilium defaults are used (no override needed):
# - enableIPv4: true (IPv4 support enabled)
# - enableIPv6: false (IPv6 disabled)
# - enableEndpointHealthChecking: true (endpoint health checks enabled)
# - enableWellKnownIdentities: true (well-known identities enabled)

# Kustomization for Proxmox CSI Driver Deployment
# ================================================
#
# This Kustomization prepares the Proxmox CSI driver for Flux GitOps deployment
# in Phase 8. It defines the resource ordering and namespace configuration.
#
# IMPORTANT: Credentials Secret must be created BEFORE deploying the CSI driver.
# The Secret is not managed by Kustomize to avoid storing credentials in Git.
#
# =============================================================================
# MANUAL INSTALLATION (PHASE 7)
# =============================================================================
#
# For manual installation, follow these steps in order:
#
# 1. Create namespace:
#    kubectl create namespace csi-proxmox
#
# 2. Create Proxmox credentials file (DO NOT commit to Git):
#    cat > proxmox-csi-config.yaml <<EOF
#    clusters:
#      - url: https://proxmox.waddle.social:8006/api2/json
#        insecure: false
#        token_id: "kubernetes-csi@pve!csi"
#        token_secret: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
#        region: proxmox
#    EOF
#
# 3. Create Kubernetes Secret:
#    kubectl create secret generic proxmox-csi-credentials \
#      --from-file=config.yaml=proxmox-csi-config.yaml \
#      -n csi-proxmox
#
# 4. Delete local credentials file:
#    rm proxmox-csi-config.yaml
#
# 5. Add Helm repo and install:
#    helm repo add proxmox-csi https://sergelogvinov.github.io/proxmox-csi-plugin
#    helm repo update
#    helm install proxmox-csi proxmox-csi/proxmox-csi-plugin \
#      --version 0.13.0 \
#      --namespace csi-proxmox \
#      --values helm-values.yaml
#
# 6. Verify installation:
#    kubectl get pods -n csi-proxmox
#    kubectl get storageclass proxmox-csi
#
# 7. Test volume provisioning:
#    kubectl apply -f verification/test-pvc.yaml
#    kubectl get pvc -n csi-test
#
# =============================================================================
# FLUX DEPLOYMENT (PHASE 8)
# =============================================================================
#
# Flux will create a HelmRelease resource referencing helm-values.yaml.
# The HelmRelease will be placed in clusters/production/infrastructure/storage.yaml
#
# Example Flux HelmRelease (to be created in Phase 8):
#
# ---
# apiVersion: source.toolkit.fluxcd.io/v1
# kind: HelmRepository
# metadata:
#   name: proxmox-csi
#   namespace: flux-system
# spec:
#   interval: 1h
#   url: https://sergelogvinov.github.io/proxmox-csi-plugin
#
# ---
# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: proxmox-csi
#   namespace: csi-proxmox
# spec:
#   interval: 1h
#   chart:
#     spec:
#       chart: proxmox-csi-plugin
#       version: 0.13.0
#       sourceRef:
#         kind: HelmRepository
#         name: proxmox-csi
#         namespace: flux-system
#   valuesFrom:
#     - kind: ConfigMap
#       name: proxmox-csi-values
#       valuesKey: values.yaml
#   dependsOn:
#     - name: cilium
#       namespace: kube-system
#
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# CSI driver runs in a dedicated namespace
namespace: csi-proxmox

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: proxmox-csi
  app.kubernetes.io/managed-by: kustomize

# Resources in this directory
# Note: Helm values are not a Kubernetes resource, so we create
# a ConfigMap wrapper for Flux valuesFrom reference
resources: []

# ConfigMap generators for Helm values
# This creates a ConfigMap from helm-values.yaml for Flux to reference
configMapGenerator:
  - name: proxmox-csi-values
    files:
      - values.yaml=helm-values.yaml
    options:
      disableNameSuffixHash: true

# =============================================================================
# DEPENDENCY NOTES
# =============================================================================
#
# Resource ordering for Proxmox CSI deployment:
#
# 1. Prerequisites:
#    - Cilium CNI installed and operational (Phase 6)
#    - Proxmox user 'kubernetes-csi@pve' created with CSI role
#    - API token created and saved
#
# 2. Namespace and Secret:
#    - csi-proxmox namespace must exist
#    - proxmox-csi-credentials Secret must be created with valid credentials
#    - Secret creation is manual (not managed by Flux) for security
#
# 3. CSI Driver (Helm release):
#    - CSI Controller Deployment (manages provisioning)
#    - CSI Node DaemonSet (manages mounting)
#    - StorageClass (enables PVC provisioning)
#
# 4. Verification:
#    - Test with PVC in verification/ directory
#    - Check volume appears in Proxmox UI
#
# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# 1. NEVER commit proxmox-csi-credentials Secret with real credentials to Git
#
# 2. For production, use one of these secret management approaches:
#    - sealed-secrets: Encrypt secrets client-side, store in Git
#    - external-secrets: Fetch from Vault, AWS SM, etc.
#    - sops: Mozilla SOPS with age/gpg encryption
#
# 3. Rotate API tokens regularly:
#    - Create new token: pveum user token add kubernetes-csi@pve csi-new
#    - Update Secret: kubectl create secret ... --dry-run=client -o yaml | kubectl apply -f -
#    - Delete old token: pveum user token remove kubernetes-csi@pve csi
#
# 4. Monitor CSI driver logs for security events:
#    kubectl logs -n csi-proxmox -l app=proxmox-csi-plugin-controller -f
#
# =============================================================================

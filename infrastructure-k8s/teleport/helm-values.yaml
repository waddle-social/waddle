# Teleport Kube Agent Helm Values
# This file configures the Teleport Kubernetes Agent to connect to the
# Teleport Auth/Proxy services running on the dedicated Teleport VM.
#
# Usage:
#   helm repo add teleport https://charts.releases.teleport.dev
#   helm repo update
#   helm install teleport-kube-agent teleport/teleport-kube-agent \
#     --namespace teleport \
#     --values helm-values.yaml
#
# IMPORTANT: Choose ONE of the following authentication methods:
#
# Option A: Set authToken directly (simpler, less secure)
#   Copy the join token from 'tctl tokens add --type=kube' and set:
#   authToken: "<your-join-token-here>"
#
# Option B: Use a Kubernetes Secret (recommended for production)
#   1. Create the secret:
#      kubectl create namespace teleport
#      kubectl create secret generic teleport-kube-agent-join-token \
#        --from-literal=auth-token=<your-join-token-here> -n teleport
#   2. Reference it via joinTokenSecret below (and remove/comment authToken)

# Teleport Proxy address (replace with your Teleport domain)
proxyAddr: teleport.waddle.social:443

# Option A: Direct token value (uncomment and set your token)
# authToken: "<your-join-token-here>"

# Option B: Reference a Kubernetes Secret containing the join token
# The secret must have a key named 'auth-token' with the token value
joinTokenSecret:
  name: teleport-kube-agent-join-token
  # If your secret uses a different key name, specify it here:
  # key: auth-token

# Roles for this agent (kube = Kubernetes access)
roles: kube

# Kubernetes cluster name as it appears in Teleport
# This name is used when users run: tsh kube login {cluster-name}
kubernetesClusterName: waddle-cluster

# Labels for this Kubernetes cluster (used in Teleport RBAC)
# These labels are matched against Teleport role's kubernetes_labels
labels:
  env: production
  region: proxmox
  cluster: waddle

# Resource limits for the agent pod
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# High availability (set to 2+ for HA in production)
replicaCount: 1

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "3000"

# Service account configuration
serviceAccount:
  create: true
  name: teleport-kube-agent

# Security context - run as non-root with minimal privileges
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Node selector (optional - schedule on specific nodes)
nodeSelector: {}

# Tolerations (optional - tolerate control plane taints if needed)
tolerations: []

# Affinity (optional - anti-affinity for HA deployment)
affinity: {}

# Log level (DEBUG, INFO, WARN, ERROR)
log:
  level: INFO
  format: json

# Additional configuration options
extraArgs:
  # Enable session recording at the node level
  - --session-recording=node
  # Uncomment to enable enhanced session recording (requires kernel 5.8+)
  # - --enhanced-recording=true

# Persistent storage for session recordings (optional)
# Enable if you want local storage for session recordings
persistence:
  enabled: false
  # storageClassName: proxmox-csi
  # size: 10Gi

# Additional volumes (if needed for custom CA certificates)
# extraVolumes:
#   - name: teleport-ca
#     secret:
#       secretName: teleport-ca-cert
#
# extraVolumeMounts:
#   - name: teleport-ca
#     mountPath: /etc/teleport-ca
#     readOnly: true

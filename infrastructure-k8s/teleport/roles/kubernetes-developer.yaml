# Teleport Role: Kubernetes Developer
#
# This role grants limited access to development and staging Kubernetes
# clusters. Developers can manage pods and deployments in specific
# namespaces but cannot access production or system namespaces.
#
# Usage:
#   sudo tctl create -f kubernetes-developer.yaml
#
# Assign to user:
#   sudo tctl users update <username> --set-roles=kubernetes-developer,access

kind: role
version: v7
metadata:
  name: kubernetes-developer
  description: Limited access to development and staging Kubernetes clusters
spec:
  allow:
    # Access to development and staging clusters only
    kubernetes_labels:
      env: ["development", "staging"]

    # Inject into 'developers' Kubernetes group
    kubernetes_groups:
      - developers
      - view

    kubernetes_users:
      - "{{internal.kubernetes_users}}"

    # Limited resource access
    kubernetes_resources:
      # Full access to pods in dev/staging namespaces
      - kind: pod
        namespace: ["dev-*", "staging-*", "default"]
        name: "*"
        verbs: ["get", "list", "watch", "create", "update", "delete"]

      # Read-only access to deployments
      - kind: deployment
        namespace: ["dev-*", "staging-*", "default"]
        name: "*"
        verbs: ["get", "list", "watch"]

      # Read-only access to services
      - kind: service
        namespace: ["dev-*", "staging-*", "default"]
        name: "*"
        verbs: ["get", "list", "watch"]

      # Read-only access to configmaps
      - kind: configmap
        namespace: ["dev-*", "staging-*", "default"]
        name: "*"
        verbs: ["get", "list", "watch"]

      # No access to secrets (explicit empty verbs)
      - kind: secret
        namespace: "*"
        name: "*"
        verbs: []

    # Session recording
    record_session:
      default: best_effort

    # Shorter session TTL for developers (8 hours)
    max_session_ttl: 8h

  deny:
    # Explicitly deny access to production
    kubernetes_labels:
      env: production

    # Deny access to system and infrastructure namespaces
    kubernetes_resources:
      - kind: "*"
        namespace: ["kube-system", "teleport", "cert-manager", "flux-system", "cilium"]
        name: "*"
        verbs: ["*"]

  options:
    # Require MFA for each session
    require_session_mfa: true
    # No agent forwarding for developers
    forward_agent: false
    # Allow port forwarding (useful for debugging)
    port_forwarding: true
    # Don't create host users
    create_host_user: false

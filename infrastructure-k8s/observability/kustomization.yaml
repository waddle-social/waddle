# =============================================================================
# OBSERVABILITY STACK KUSTOMIZATION
# =============================================================================
#
# Phase 13: LGTM Observability Stack (Loki, Grafana, Tempo, Mimir)
#
# This kustomization deploys:
# - Namespace for observability components
# - ConfigMaps containing Helm values for Flux HelmReleases
#
# Prerequisites:
# - Phase 6: Cilium CNI operational
# - Phase 7: Proxmox CSI driver installed
# - Phase 8: Flux GitOps setup complete
#
# Manual Installation (Phase 13):
# 1. Create namespace: kubectl apply -f namespace.yaml
# 2. Create Grafana admin secret (see grafana/admin-secret.example.yaml)
# 3. Deploy Prometheus Operator (CRDs only):
#    helm install prometheus-operator prometheus-community/kube-prometheus-stack \
#      -n observability -f prometheus-operator/helm-values.yaml
# 4. Deploy Loki:
#    helm install loki grafana/loki -n observability -f loki/helm-values.yaml
# 5. Deploy Tempo:
#    helm install tempo grafana/tempo -n observability -f tempo/helm-values.yaml
# 6. Deploy Mimir:
#    helm install mimir grafana/mimir-distributed -n observability -f mimir/helm-values.yaml
# 7. Deploy OpenTelemetry Collector:
#    helm install otel opentelemetry/opentelemetry-collector \
#      -n observability -f opentelemetry/helm-values.yaml
# 8. Deploy Grafana:
#    helm install grafana grafana/grafana -n observability -f grafana/helm-values.yaml
#
# Flux Deployment:
# HelmReleases in clusters/production/infrastructure/ reference ConfigMaps here
# via valuesFrom for GitOps-driven configuration management.
#
# Security Notes:
# - NEVER commit Grafana admin password to git
# - Create admin password via kubectl or sealed-secrets
# - Use network policies to restrict inter-component traffic
#
# Storage Notes (Proxmox CSI):
# - Loki: 50Gi for ~30 days of logs
# - Tempo: 30Gi for ~30 days of traces
# - Mimir: 100Gi for ~30 days of metrics
# - Grafana: 10Gi for dashboards and config
#
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability

commonLabels:
  app.kubernetes.io/part-of: observability
  app.kubernetes.io/managed-by: kustomize

resources:
  - namespace.yaml

# ConfigMaps for Helm values - referenced by Flux HelmReleases
configMapGenerator:
  - name: prometheus-operator-values
    files:
      - values.yaml=prometheus-operator/helm-values.yaml
    options:
      disableNameSuffixHash: true

  - name: grafana-values
    files:
      - values.yaml=grafana/helm-values.yaml
    options:
      disableNameSuffixHash: true

  - name: loki-values
    files:
      - values.yaml=loki/helm-values.yaml
    options:
      disableNameSuffixHash: true

  - name: tempo-values
    files:
      - values.yaml=tempo/helm-values.yaml
    options:
      disableNameSuffixHash: true

  - name: mimir-values
    files:
      - values.yaml=mimir/helm-values.yaml
    options:
      disableNameSuffixHash: true

  - name: otel-collector-values
    files:
      - values.yaml=opentelemetry/helm-values.yaml
    options:
      disableNameSuffixHash: true

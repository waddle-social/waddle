# =============================================================================
# GRAFANA HELM VALUES
# =============================================================================
#
# Chart: grafana/grafana
# Version: 8.x.x
#
# Purpose: Deploy Grafana for unified visualization of logs, metrics, and traces.
#
# Usage:
#   helm repo add grafana https://grafana.github.io/helm-charts
#   helm install grafana grafana/grafana -n observability -f helm-values.yaml
#
# Prerequisites:
# - Namespace 'observability' created
# - Grafana admin secret created (see admin-secret.example.yaml)
# - Loki, Tempo, Mimir deployed and accessible
# - Proxmox CSI driver installed (Phase 7)
#
# Admin Password:
#   NEVER commit actual password to git!
#   Create secret first:
#     kubectl create secret generic grafana-admin \
#       --from-literal=admin-password=$(openssl rand -base64 32) \
#       -n observability
#
# Access:
#   kubectl port-forward -n observability svc/grafana 3000:80
#   Open http://localhost:3000
#   Login: admin / <password-from-secret>
#
# Data Sources:
#   Pre-configured for Loki, Tempo, and Mimir (see datasources section below)
#
# Dashboards:
#   Auto-provisioned from ConfigMaps with label grafana_dashboard="1"
#   See dashboards/ directory for pre-configured dashboards
#
# Verification:
#   kubectl get pods -n observability -l app.kubernetes.io/name=grafana
#   kubectl get pvc -n observability | grep grafana
#
# Troubleshooting:
# - Login fails: Verify secret exists and is correctly referenced
# - Data source errors: Check service endpoints are accessible
# - Dashboard missing: Verify ConfigMap labels and sidecar configuration
# - PVC pending: Check Proxmox CSI driver status
#
# =============================================================================

# -----------------------------------------------------------------------------
# Replicas
# -----------------------------------------------------------------------------
replicas: 1

# -----------------------------------------------------------------------------
# Admin Credentials
# -----------------------------------------------------------------------------
admin:
  existingSecret: grafana-admin
  userKey: admin-user
  passwordKey: admin-password

# Default admin user (password from secret)
adminUser: admin

# -----------------------------------------------------------------------------
# Persistence
# -----------------------------------------------------------------------------
persistence:
  enabled: true
  type: pvc
  storageClassName: proxmox-csi
  size: 10Gi
  accessModes:
    - ReadWriteOnce

# -----------------------------------------------------------------------------
# Service
# -----------------------------------------------------------------------------
service:
  type: ClusterIP
  port: 80
  targetPort: 3000

# -----------------------------------------------------------------------------
# Ingress - DISABLED (use Gateway API HTTPRoute instead)
# -----------------------------------------------------------------------------
ingress:
  enabled: false

# -----------------------------------------------------------------------------
# Resources
# -----------------------------------------------------------------------------
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 1Gi

# -----------------------------------------------------------------------------
# Node Selector (control-plane nodes)
# -----------------------------------------------------------------------------
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

# -----------------------------------------------------------------------------
# Tolerations (control-plane taints)
# -----------------------------------------------------------------------------
tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# -----------------------------------------------------------------------------
# Security Context
# -----------------------------------------------------------------------------
securityContext:
  runAsNonRoot: true
  runAsUser: 472
  runAsGroup: 472
  fsGroup: 472

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false  # Grafana needs write access
  capabilities:
    drop:
      - ALL

# -----------------------------------------------------------------------------
# Data Sources - Pre-configured for LGTM stack
# -----------------------------------------------------------------------------
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # Loki - Log aggregation
      - name: Loki
        type: loki
        access: proxy
        url: http://loki.observability.svc.cluster.local:3100
        isDefault: false
        editable: false
        jsonData:
          maxLines: 1000

      # Tempo - Distributed tracing
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.observability.svc.cluster.local:3100
        isDefault: false
        editable: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            tags: ['namespace', 'pod']
          tracesToMetrics:
            datasourceUid: mimir
            tags: ['namespace', 'pod']
          lokiSearch:
            datasourceUid: loki

      # Mimir - Metrics storage (Prometheus-compatible)
      - name: Mimir
        type: prometheus
        access: proxy
        url: http://mimir-nginx.observability.svc.cluster.local:80/prometheus
        isDefault: true
        editable: false
        jsonData:
          timeInterval: 30s
          httpMethod: POST

# -----------------------------------------------------------------------------
# Dashboard Provisioning - Auto-discover from ConfigMaps
# -----------------------------------------------------------------------------
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Sidecar for auto-discovering dashboard ConfigMaps
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: "1"
    folder: /var/lib/grafana/dashboards/default
    folderAnnotation: grafana_folder
    searchNamespace: ALL
    provider:
      foldersFromFilesStructure: true
  datasources:
    enabled: false  # Using datasources.yaml above instead

# -----------------------------------------------------------------------------
# Plugins
# -----------------------------------------------------------------------------
plugins:
  - grafana-piechart-panel
  - grafana-clock-panel

# -----------------------------------------------------------------------------
# Grafana Configuration
# -----------------------------------------------------------------------------
grafana.ini:
  server:
    root_url: "%(protocol)s://%(domain)s/"
  analytics:
    check_for_updates: false
    reporting_enabled: false
  security:
    disable_gravatar: true
  users:
    allow_sign_up: false
    auto_assign_org: true
    auto_assign_org_role: Viewer
  auth:
    disable_login_form: false
  log:
    mode: console
    level: info

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: grafana

# -----------------------------------------------------------------------------
# RBAC
# -----------------------------------------------------------------------------
rbac:
  create: true
  pspEnabled: false

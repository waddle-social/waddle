# =============================================================================
# PROMETHEUS OPERATOR HELM VALUES (kube-prometheus-stack)
# =============================================================================
#
# Chart: prometheus-community/kube-prometheus-stack
# Version: 67.x.x
#
# Purpose: Deploy ONLY the Prometheus Operator for CRD management.
# Prometheus, Alertmanager, and Grafana are disabled (using Mimir and separate Grafana).
#
# Usage:
#   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
#   helm install prometheus-operator prometheus-community/kube-prometheus-stack \
#     -n observability -f helm-values.yaml
#
# Prerequisites:
# - Cilium CNI operational (Phase 6)
# - Proxmox CSI driver installed (Phase 7) - not used by operator
# - Namespace 'observability' created
#
# CRDs Installed:
# - ServiceMonitor - scrape configuration for services
# - PodMonitor - scrape configuration for pods
# - PrometheusRule - alerting/recording rules
# - Probe - blackbox probing configuration
# - ScrapeConfig - additional scrape targets
#
# Verification:
#   kubectl get crd | grep monitoring.coreos.com
#   kubectl get pods -n observability -l app=kube-prometheus-stack-operator
#
# Troubleshooting:
# - CRDs not installed: Check Helm install output, ensure crds.enabled=true
# - Operator not starting: Check pod logs, node selector/tolerations
# - ServiceMonitors not discovered: Verify labels match operator configuration
#
# =============================================================================

# -----------------------------------------------------------------------------
# CRD Installation
# -----------------------------------------------------------------------------
crds:
  enabled: true

# -----------------------------------------------------------------------------
# Prometheus - DISABLED (using Mimir for metrics storage)
# -----------------------------------------------------------------------------
prometheus:
  enabled: false

# -----------------------------------------------------------------------------
# Alertmanager - DISABLED (future phase)
# -----------------------------------------------------------------------------
alertmanager:
  enabled: false

# -----------------------------------------------------------------------------
# Grafana - DISABLED (separate deployment with custom configuration)
# -----------------------------------------------------------------------------
grafana:
  enabled: false

# -----------------------------------------------------------------------------
# Node Exporter - DISABLED (can enable if Talos metrics insufficient)
# -----------------------------------------------------------------------------
nodeExporter:
  enabled: false

# -----------------------------------------------------------------------------
# Kube State Metrics - DISABLED (can enable for cluster state metrics)
# -----------------------------------------------------------------------------
kubeStateMetrics:
  enabled: false

# -----------------------------------------------------------------------------
# Prometheus Operator - ENABLED
# -----------------------------------------------------------------------------
prometheusOperator:
  enabled: true

  # Resource limits
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 512Mi

  # Schedule on control-plane nodes (Talos)
  nodeSelector:
    node-role.kubernetes.io/control-plane: ""

  # Tolerate control-plane taints
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  # Priority class for critical infrastructure
  priorityClassName: system-cluster-critical

  # Admission webhooks (optional, can disable if causing issues)
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true

  # Service account
  serviceAccount:
    create: true
    name: prometheus-operator

# -----------------------------------------------------------------------------
# Default Rules - DISABLED (no Prometheus to evaluate them)
# -----------------------------------------------------------------------------
defaultRules:
  create: false

# -----------------------------------------------------------------------------
# Kubelet Service - DISABLED (no Prometheus to scrape)
# -----------------------------------------------------------------------------
kubelet:
  enabled: false

# -----------------------------------------------------------------------------
# CoreDNS - DISABLED
# -----------------------------------------------------------------------------
coreDns:
  enabled: false

# -----------------------------------------------------------------------------
# Kube API Server - DISABLED
# -----------------------------------------------------------------------------
kubeApiServer:
  enabled: false

# -----------------------------------------------------------------------------
# Kube Controller Manager - DISABLED
# -----------------------------------------------------------------------------
kubeControllerManager:
  enabled: false

# -----------------------------------------------------------------------------
# Kube Scheduler - DISABLED
# -----------------------------------------------------------------------------
kubeScheduler:
  enabled: false

# -----------------------------------------------------------------------------
# Kube Proxy - DISABLED
# -----------------------------------------------------------------------------
kubeProxy:
  enabled: false

# -----------------------------------------------------------------------------
# Kube Etcd - DISABLED
# -----------------------------------------------------------------------------
kubeEtcd:
  enabled: false

# =============================================================================
# LOKI HELM VALUES
# =============================================================================
#
# Chart: grafana/loki
# Version: 6.x.x
#
# Purpose: Deploy Loki for log aggregation with LogQL query support.
#
# Usage:
#   helm repo add grafana https://grafana.github.io/helm-charts
#   helm install loki grafana/loki -n observability -f helm-values.yaml
#
# Prerequisites:
# - Namespace 'observability' created
# - Proxmox CSI driver installed (Phase 7)
#
# Deployment Mode: SingleBinary
#   Simple single-process deployment suitable for small to medium clusters.
#   For high availability, consider SimpleScalable or Distributed modes.
#
# Storage: Filesystem via PVC (Proxmox CSI)
#   50Gi provides ~30 days of logs for a small cluster.
#   Adjust size based on log volume and retention requirements.
#
# Verification:
#   kubectl get pods -n observability -l app.kubernetes.io/name=loki
#   kubectl get pvc -n observability | grep loki
#   # Test query:
#   kubectl port-forward -n observability svc/loki 3100
#   curl http://localhost:3100/ready
#
# Query Examples (LogQL):
#   {namespace="observability"}
#   {namespace="kube-system"} |= "error"
#   rate({namespace="default"}[5m])
#
# Troubleshooting:
# - PVC pending: Check Proxmox CSI driver status
# - OOM: Increase memory limits, reduce chunk sizes
# - Slow queries: Add label filters, use time ranges
# - Ingestion failures: Check OTel Collector logs
#
# =============================================================================

# -----------------------------------------------------------------------------
# Deployment Mode
# -----------------------------------------------------------------------------
deploymentMode: SingleBinary

# -----------------------------------------------------------------------------
# Loki Configuration
# -----------------------------------------------------------------------------
loki:
  # Disable multi-tenancy for simplicity
  auth_enabled: false

  # Common configuration
  commonConfig:
    replication_factor: 1
    path_prefix: /var/loki

  # Schema configuration (v13 is latest)
  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h

  # Storage configuration
  storage:
    type: filesystem

  # Retention configuration
  limits_config:
    retention_period: 720h  # 30 days
    max_query_length: 721h
    max_query_parallelism: 32
    max_query_series: 10000
    ingestion_rate_mb: 16
    ingestion_burst_size_mb: 32
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 15MB

  # Ingester configuration
  ingester:
    chunk_idle_period: 30m
    chunk_retain_period: 1m
    max_chunk_age: 1h
    chunk_target_size: 1572864  # 1.5MB
    lifecycler:
      ring:
        replication_factor: 1

  # Compactor configuration
  compactor:
    working_directory: /var/loki/compactor
    retention_enabled: true
    retention_delete_delay: 2h
    delete_request_store: filesystem

  # Query configuration
  query_scheduler:
    max_outstanding_requests_per_tenant: 2048

  # Server configuration
  server:
    http_listen_port: 3100
    grpc_listen_port: 9095
    log_level: info

  # Security Context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001

  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

# -----------------------------------------------------------------------------
# Single Binary Configuration
# -----------------------------------------------------------------------------
singleBinary:
  replicas: 1

  # Persistence
  persistence:
    enabled: true
    storageClass: proxmox-csi
    size: 50Gi
    enableStatefulSetAutoDeletePVC: false

  # Resources
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 2Gi

  # Node selector (control-plane nodes)
  nodeSelector:
    node-role.kubernetes.io/control-plane: ""

  # Tolerations (control-plane taints)
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  # Extra volumes for tmp
  extraVolumes:
    - name: tmp
      emptyDir: {}

  extraVolumeMounts:
    - name: tmp
      mountPath: /tmp

# Security Context is now consolidated into the main loki: block above

# -----------------------------------------------------------------------------
# Service
# -----------------------------------------------------------------------------
service:
  type: ClusterIP

# -----------------------------------------------------------------------------
# Gateway - Disabled (direct access to Loki)
# -----------------------------------------------------------------------------
gateway:
  enabled: false

# -----------------------------------------------------------------------------
# Monitoring - ServiceMonitor
# -----------------------------------------------------------------------------
monitoring:
  serviceMonitor:
    enabled: true
    labels:
      app.kubernetes.io/part-of: observability

# -----------------------------------------------------------------------------
# Read/Write/Backend - Disabled for SingleBinary mode
# -----------------------------------------------------------------------------
read:
  replicas: 0
write:
  replicas: 0
backend:
  replicas: 0

# -----------------------------------------------------------------------------
# Test - Disabled
# -----------------------------------------------------------------------------
test:
  enabled: false

# -----------------------------------------------------------------------------
# Lokicanary - Disabled
# -----------------------------------------------------------------------------
lokiCanary:
  enabled: false

# -----------------------------------------------------------------------------
# Chunk Cache - Embedded
# -----------------------------------------------------------------------------
chunksCache:
  enabled: true
  allocatedMemory: 512

# -----------------------------------------------------------------------------
# Results Cache - Embedded
# -----------------------------------------------------------------------------
resultsCache:
  enabled: true
  allocatedMemory: 256

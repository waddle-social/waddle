# =============================================================================
# ALERTMANAGER HELM VALUES (REFERENCE ONLY)
# =============================================================================
#
# NOTE: This file is for reference only. The actual values used by Flux are
# embedded in clusters/production/infrastructure/observability-alertmanager-helmrelease.yaml
# as a ConfigMap. When making changes, update the HelmRelease file directly.
#
# Alertmanager for alert routing and notification.
# Chart: prometheus-community/alertmanager
#
# Prerequisites:
# - Prometheus Operator deployed (PrometheusRule CRD)
# - alertmanager-config Secret created with notification credentials
#
# =============================================================================

# High availability with gossip clustering
replicaCount: 3

image:
  repository: quay.io/prometheus/alertmanager
  tag: v0.27.0
  pullPolicy: IfNotPresent

# Resource limits
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 512Mi

# Persistent storage
persistence:
  enabled: true
  storageClass: proxmox-csi
  accessModes:
    - ReadWriteOnce
  size: 10Gi

# Data retention
retention: 120h  # 5 days

# Configuration from Secret
configmapReload:
  enabled: true

# Use external Secret for configuration
config:
  enabled: false  # We use alertmanager-config Secret instead

configFrom:
  - secretRef:
      name: alertmanager-config
      key: alertmanager.yaml

# Service configuration
service:
  type: ClusterIP
  port: 9093
  annotations: {}

# Ingress disabled - use port-forward or Grafana integration
ingress:
  enabled: false

# Pod scheduling
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# Pod anti-affinity for HA
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - alertmanager
          topologyKey: kubernetes.io/hostname

# Security context
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

containerSecurityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# ServiceMonitor for Prometheus scraping
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s

# Pod disruption budget for HA
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Cluster gossip configuration for HA
extraArgs:
  cluster.listen-address: "0.0.0.0:9094"
  cluster.peer: "alertmanager-0.alertmanager-headless.observability.svc.cluster.local:9094"
  cluster.peer: "alertmanager-1.alertmanager-headless.observability.svc.cluster.local:9094"
  cluster.peer: "alertmanager-2.alertmanager-headless.observability.svc.cluster.local:9094"

# =============================================================================
# CLOUDNATIVEPG OPERATOR NAMESPACE NETWORK POLICY
# =============================================================================
#
# Allow traffic for CloudNativePG operator in cnpg-system:
# - Kubernetes API access for cluster management
# - Webhook traffic for admission control
# - Metrics scraping from observability
#
# Note: PostgreSQL cluster pods run in application namespaces (e.g., spicedb)
# and are covered by namespace-specific policies.
#
# =============================================================================
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cnpg-operator
  namespace: cnpg-system
  labels:
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: cloudnative-pg
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Webhook traffic from Kubernetes API server
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: TCP
          port: 9443  # Webhook server
    
    # Metrics scraping from observability
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 8080  # Metrics

  egress:
    # Kubernetes API server for cluster management
    # Using ipBlock to correctly target the API server ClusterIP
    # Default service CIDR typically assigns 10.96.0.1 to kubernetes.default.svc
    # Adjust the CIDR if your cluster uses a different service IP range
    - to:
        - ipBlock:
            cidr: 10.96.0.1/32
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    
    # Connect to PostgreSQL clusters in any namespace
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              cnpg.io/podRole: instance
      ports:
        - protocol: TCP
          port: 5432

---
# Allow CNPG operator to manage resources across namespaces
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cnpg-cross-namespace
  namespace: cnpg-system
  labels:
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: cloudnative-pg
  policyTypes:
    - Egress
  egress:
    # Allow connection to all PostgreSQL instances managed by CNPG
    - to:
        - namespaceSelector:
            matchLabels:
              cnpg.io/managed: "true"
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 9187  # Metrics

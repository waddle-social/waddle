# Kustomization for cert-manager Deployment
# ==========================================
#
# This Kustomization prepares cert-manager for Flux GitOps deployment in Phase 9.
# It defines the resource ordering and namespace configuration.
#
# IMPORTANT: Cloudflare API token Secret must be created BEFORE deploying cert-manager.
# The Secret is not managed by Kustomize to avoid storing credentials in Git.
#
# =============================================================================
# MANUAL INSTALLATION (PHASE 9)
# =============================================================================
#
# For manual installation, follow these steps in order:
#
# 1. Create namespace:
#    kubectl create namespace cert-manager
#
# 2. Create Cloudflare API token (see https://dash.cloudflare.com/profile/api-tokens):
#    - Permission: Zone:DNS:Edit
#    - Zone Resources: Include > All zones (or specific zone)
#
# 3. Create Kubernetes Secret:
#    kubectl create secret generic cloudflare-api-token \
#      --from-literal=api-token=<your-cloudflare-api-token> \
#      -n cert-manager
#
# 4. Add Helm repo and install:
#    helm repo add jetstack https://charts.jetstack.io
#    helm repo update
#    helm install cert-manager jetstack/cert-manager \
#      --version v1.16.2 \
#      --namespace cert-manager \
#      --values helm-values.yaml
#
# 5. Create ClusterIssuers (after cert-manager is ready):
#    kubectl apply -f clusterissuers/clusterissuer-letsencrypt-staging.yaml
#    kubectl apply -f clusterissuers/clusterissuer-letsencrypt-production.yaml
#
# 6. Verify installation:
#    kubectl get pods -n cert-manager
#    kubectl get clusterissuer
#
# 7. Test certificate issuance:
#    kubectl apply -f verification/test-certificate.yaml
#    kubectl get certificate -n cert-manager
#
# =============================================================================
# FLUX DEPLOYMENT (PHASE 9)
# =============================================================================
#
# Flux will create a HelmRelease resource referencing helm-values.yaml.
# The HelmRelease will be placed in clusters/production/infrastructure/cert-manager-helmrelease.yaml
#
# Example Flux HelmRelease (created in Phase 9):
#
# ---
# apiVersion: source.toolkit.fluxcd.io/v1
# kind: HelmRepository
# metadata:
#   name: cert-manager
#   namespace: flux-system
# spec:
#   interval: 1h
#   url: https://charts.jetstack.io
#
# ---
# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: cert-manager
#   namespace: cert-manager
# spec:
#   interval: 1h
#   chart:
#     spec:
#       chart: cert-manager
#       version: v1.16.2
#       sourceRef:
#         kind: HelmRepository
#         name: cert-manager
#         namespace: flux-system
#   valuesFrom:
#     - kind: ConfigMap
#       name: cert-manager-values
#       valuesKey: values.yaml
#   dependsOn:
#     - name: cilium
#       namespace: kube-system
#
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# cert-manager runs in a dedicated namespace
namespace: cert-manager

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: cert-manager
  app.kubernetes.io/managed-by: kustomize

# Resources in this directory
# Note: Helm values are not a Kubernetes resource, so we create
# a ConfigMap wrapper for Flux valuesFrom reference
# ClusterIssuers are applied separately after cert-manager is ready
resources: []

# ConfigMap generators for Helm values
# This creates a ConfigMap from helm-values.yaml for Flux to reference
configMapGenerator:
  - name: cert-manager-values
    files:
      - values.yaml=helm-values.yaml
    options:
      disableNameSuffixHash: true

# =============================================================================
# DEPENDENCY NOTES
# =============================================================================
#
# Resource ordering for cert-manager deployment:
#
# 1. Prerequisites:
#    - Cilium CNI installed and operational (Phase 6)
#    - Cloudflare account with domain(s) to manage
#    - Cloudflare API token with Zone:DNS:Edit permissions
#
# 2. Namespace and Secret:
#    - cert-manager namespace must exist
#    - cloudflare-api-token Secret must be created with valid token
#    - Secret creation is manual (not managed by Flux) for security
#
# 3. cert-manager (Helm release):
#    - Controller Deployment
#    - Webhook Deployment
#    - Cainjector Deployment
#    - CRDs (managed by Helm)
#
# 4. ClusterIssuers (after cert-manager is ready):
#    - letsencrypt-staging (for testing)
#    - letsencrypt-production (for real certificates)
#
# 5. Verification:
#    - Test with Certificate in verification/ directory
#    - Check certificate is issued and secret is created
#
# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# 1. NEVER commit cloudflare-api-token Secret with real credentials to Git
#
# 2. For production, use one of these secret management approaches:
#    - sealed-secrets: Encrypt secrets client-side, store in Git
#    - external-secrets: Fetch from Vault, AWS SM, etc.
#    - sops: Mozilla SOPS with age/gpg encryption
#
# 3. Rotate Cloudflare API tokens regularly:
#    - Create new token in Cloudflare dashboard
#    - Update Secret: kubectl create secret generic cloudflare-api-token \
#        --from-literal=api-token=<new-token> -n cert-manager --dry-run=client -o yaml | kubectl apply -f -
#    - Delete old token in Cloudflare dashboard
#
# 4. Monitor cert-manager logs for security events:
#    kubectl logs -n cert-manager -l app.kubernetes.io/component=controller -f
#
# =============================================================================

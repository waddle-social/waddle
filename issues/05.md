# Issue #05: Database Schema Design

## User Story
As a **platform architect**, I want to **design a scalable database schema** so that **we can efficiently store and query chat data while respecting the 10GB D1 limit**.

## Description
Design and implement the complete database schema across our distributed D1 architecture. This includes the central directory database and per-waddle databases with proper indexing and partitioning strategies.

## Acceptance Criteria
- [ ] Central directory schema handles user accounts and waddle registry
- [ ] Per-waddle schema optimized for message queries
- [ ] Proper indexes for common query patterns
- [ ] Schema supports future sharding needs
- [ ] GDPR-compliant data separation
- [ ] Migration scripts for schema updates
- [ ] Monitoring for database size limits

## Technical Implementation

### 1. Central Directory Database Schema
```sql
-- Users table (GDPR: personal data)
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE,
  username TEXT UNIQUE NOT NULL,
  display_name TEXT,
  avatar_url TEXT,
  bio TEXT,
  is_anonymous BOOLEAN DEFAULT FALSE,
  locale TEXT DEFAULT 'en',
  timezone TEXT DEFAULT 'UTC',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME, -- Soft delete for GDPR
  
  INDEX idx_email (email),
  INDEX idx_username (username),
  INDEX idx_created (created_at)
);

-- User settings (separate for easy GDPR export)
CREATE TABLE user_settings (
  user_id TEXT PRIMARY KEY,
  notifications_enabled BOOLEAN DEFAULT TRUE,
  notification_sound TEXT DEFAULT 'default',
  theme TEXT DEFAULT 'auto',
  compact_mode BOOLEAN DEFAULT FALSE,
  developer_mode BOOLEAN DEFAULT FALSE,
  settings_json JSON, -- Extensible settings
  
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Waddles directory
CREATE TABLE waddles (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL, -- URL-safe name
  display_name TEXT NOT NULL,
  description TEXT,
  icon_url TEXT,
  banner_url TEXT,
  owner_id TEXT NOT NULL,
  is_public BOOLEAN DEFAULT FALSE,
  is_verified BOOLEAN DEFAULT FALSE,
  member_count INTEGER DEFAULT 0,
  message_count INTEGER DEFAULT 0,
  shard_count INTEGER DEFAULT 1,
  d1_database_id TEXT NOT NULL,
  database_size_mb INTEGER DEFAULT 0,
  features JSON DEFAULT '[]', -- ['voice', 'livestream', 'ai']
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_name (name),
  INDEX idx_public (is_public, member_count DESC),
  INDEX idx_owner (owner_id),
  FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- Waddle memberships
CREATE TABLE waddle_members (
  waddle_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  nickname TEXT, -- Per-waddle display name
  joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_read_at DATETIME,
  notification_level TEXT DEFAULT 'all', -- 'all', 'mentions', 'none'
  
  PRIMARY KEY (waddle_id, user_id),
  INDEX idx_user_waddles (user_id, joined_at DESC),
  INDEX idx_waddle_users (waddle_id, joined_at DESC),
  FOREIGN KEY (waddle_id) REFERENCES waddles(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Global bans (platform-wide)
CREATE TABLE global_bans (
  user_id TEXT PRIMARY KEY,
  reason TEXT NOT NULL,
  banned_by TEXT NOT NULL,
  banned_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (banned_by) REFERENCES users(id)
);

-- Audit log for compliance
CREATE TABLE audit_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT,
  action TEXT NOT NULL,
  resource_type TEXT,
  resource_id TEXT,
  metadata JSON,
  ip_address TEXT,
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_user_actions (user_id, created_at DESC),
  INDEX idx_resource (resource_type, resource_id)
);
```

### 2. Per-Waddle Database Schema
```sql
-- Channels within a waddle
CREATE TABLE channels (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL, -- 'text', 'voice', 'announcement', 'thread'
  description TEXT,
  position INTEGER DEFAULT 0,
  category_id TEXT,
  is_private BOOLEAN DEFAULT FALSE,
  is_archived BOOLEAN DEFAULT FALSE,
  thread_mode TEXT DEFAULT 'optional', -- 'required', 'optional', 'disabled'
  slow_mode_seconds INTEGER DEFAULT 0,
  auto_archive_hours INTEGER DEFAULT 168, -- 7 days
  created_by TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_category (category_id, position),
  INDEX idx_type (type, is_archived)
);

-- Channel categories
CREATE TABLE categories (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  position INTEGER DEFAULT 0,
  collapsed_by_default BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Messages (optimized for common queries)
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  channel_id TEXT NOT NULL,
  thread_id TEXT, -- For Zulip-style topics
  user_id TEXT NOT NULL,
  content TEXT,
  content_type TEXT DEFAULT 'text', -- 'text', 'image', 'file', 'system'
  metadata JSON, -- Attachments, embeds, etc.
  reply_to_id TEXT,
  edit_count INTEGER DEFAULT 0,
  is_pinned BOOLEAN DEFAULT FALSE,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  edited_at DATETIME,
  
  -- Composite index for channel message queries
  INDEX idx_channel_time (channel_id, created_at DESC),
  -- Index for thread queries
  INDEX idx_thread_time (thread_id, created_at) WHERE thread_id IS NOT NULL,
  -- Index for user's messages
  INDEX idx_user_messages (user_id, created_at DESC),
  -- Full-text search
  INDEX idx_content_fts (content) -- Using FTS5
);

-- Message reactions
CREATE TABLE reactions (
  message_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  emoji TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (message_id, user_id, emoji),
  INDEX idx_message_reactions (message_id)
);

-- Threads (Zulip-style topics)
CREATE TABLE threads (
  id TEXT PRIMARY KEY,
  channel_id TEXT NOT NULL,
  title TEXT NOT NULL,
  created_by TEXT NOT NULL,
  message_count INTEGER DEFAULT 0,
  last_message_at DATETIME,
  is_locked BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_channel_threads (channel_id, last_message_at DESC),
  INDEX idx_thread_activity (last_message_at DESC)
);

-- Roles and permissions
CREATE TABLE roles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  color TEXT,
  permissions INTEGER NOT NULL, -- Bitfield
  position INTEGER DEFAULT 0,
  is_mentionable BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_position (position)
);

-- Member roles
CREATE TABLE member_roles (
  user_id TEXT NOT NULL,
  role_id TEXT NOT NULL,
  granted_by TEXT NOT NULL,
  granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (user_id, role_id),
  INDEX idx_user_roles (user_id),
  INDEX idx_role_members (role_id)
);

-- Waddle bans
CREATE TABLE bans (
  user_id TEXT PRIMARY KEY,
  reason TEXT,
  banned_by TEXT NOT NULL,
  banned_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME
);

-- Voice session history
CREATE TABLE voice_sessions (
  id TEXT PRIMARY KEY,
  channel_id TEXT NOT NULL,
  rtk_session_id TEXT,
  started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  ended_at DATETIME,
  max_participants INTEGER DEFAULT 0,
  recording_url TEXT,
  
  INDEX idx_channel_sessions (channel_id, started_at DESC)
);
```

### 3. Schema Monitoring and Management
```javascript
// Monitor database size
export class DatabaseMonitor {
  static async checkDatabaseSize(waddleId, env) {
    const db = env[`WADDLE_DB_${waddleId}`];
    
    // Get database size
    const sizeResult = await db.prepare(`
      SELECT page_count * page_size as size_bytes
      FROM pragma_page_count(), pragma_page_size()
    `).first();
    
    const sizeMB = sizeResult.size_bytes / (1024 * 1024);
    
    // Update central directory
    await env.CENTRAL_DB.prepare(`
      UPDATE waddles 
      SET database_size_mb = ?
      WHERE id = ?
    `).bind(Math.round(sizeMB), waddleId).run();
    
    // Alert if approaching limit
    if (sizeMB > 8000) { // 80% of 10GB
      await this.alertDatabaseSizeWarning(waddleId, sizeMB, env);
    }
    
    return sizeMB;
  }
  
  static async optimizeDatabase(waddleId, env) {
    const db = env[`WADDLE_DB_${waddleId}`];
    
    // Run optimization
    await db.prepare('PRAGMA optimize').run();
    
    // Vacuum if needed (this locks the database briefly)
    const autoVacuum = await db.prepare('PRAGMA auto_vacuum').first();
    if (autoVacuum.auto_vacuum === 0) {
      await db.prepare('VACUUM').run();
    }
  }
}
```

### 4. Migration System
```javascript
// Migration runner
export class MigrationRunner {
  static async runMigrations(db, migrations) {
    // Create migrations table
    await db.prepare(`
      CREATE TABLE IF NOT EXISTS migrations (
        version INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        applied_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run();
    
    // Get current version
    const current = await db.prepare(
      'SELECT MAX(version) as version FROM migrations'
    ).first();
    
    const currentVersion = current?.version || 0;
    
    // Run pending migrations
    for (const migration of migrations) {
      if (migration.version > currentVersion) {
        console.log(`Running migration ${migration.version}: ${migration.name}`);
        
        await db.batch(migration.up);
        
        await db.prepare(
          'INSERT INTO migrations (version, name) VALUES (?, ?)'
        ).bind(migration.version, migration.name).run();
      }
    }
  }
}

// Example migration
const migrations = [
  {
    version: 1,
    name: 'add_message_attachments',
    up: [
      `CREATE TABLE message_attachments (
        id TEXT PRIMARY KEY,
        message_id TEXT NOT NULL,
        filename TEXT NOT NULL,
        size_bytes INTEGER NOT NULL,
        mime_type TEXT,
        url TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        
        INDEX idx_message (message_id)
      )`
    ]
  }
];
```

### 5. Query Optimization Patterns
```javascript
// Efficient message pagination
export async function getChannelMessages(channelId, cursor, limit = 50, db) {
  const query = cursor
    ? `SELECT * FROM messages 
       WHERE channel_id = ? AND created_at < ?
       ORDER BY created_at DESC
       LIMIT ?`
    : `SELECT * FROM messages 
       WHERE channel_id = ?
       ORDER BY created_at DESC
       LIMIT ?`;
  
  const params = cursor 
    ? [channelId, cursor, limit]
    : [channelId, limit];
  
  const results = await db.prepare(query).bind(...params).all();
  
  return {
    messages: results.results.reverse(), // Oldest first
    cursor: results.results[0]?.created_at // Next cursor
  };
}

// Efficient thread queries with activity
export async function getActiveThreads(channelId, limit = 20, db) {
  const threads = await db.prepare(`
    SELECT t.*, 
           COUNT(m.id) as recent_messages,
           MAX(m.created_at) as last_activity
    FROM threads t
    LEFT JOIN messages m ON t.id = m.thread_id 
      AND m.created_at > datetime('now', '-24 hours')
    WHERE t.channel_id = ?
    GROUP BY t.id
    ORDER BY last_activity DESC
    LIMIT ?
  `).bind(channelId, limit).all();
  
  return threads.results;
}
```

## Dependencies
- Waddle entity model (Issue #01) for structure
- Cloudflare D1 access

## Estimated Effort
**3 days**
- 1 day: Schema design and documentation
- 1 day: Implementation and indexes
- 1 day: Migration system and monitoring

## Notes
- FTS5 provides full-text search capabilities
- Monitor index performance with EXPLAIN QUERY PLAN
- Consider archiving old messages to R2 if approaching limits
- Plan for read replicas when available in D1
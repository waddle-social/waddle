---
import '../tailwind.css';
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Colony - Bluesky Authentication</title>
	</head>
	<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
		<div class="w-full max-w-md">
			<div class="bg-white rounded-2xl shadow-xl p-8">
				<div class="text-center mb-8">
					<h1 class="text-3xl font-bold text-gray-900 mb-2">Colony</h1>
					<p class="text-gray-600">Connect with your Bluesky account</p>
				</div>

				<div class="space-y-6">
					<!-- Bluesky Login Form -->
					<div id="login-form" class="space-y-4">
						<h2 class="text-xl font-semibold text-gray-800">Sign In with Bluesky</h2>
						<form id="bluesky-auth-form" class="space-y-4">
							<div>
								<label for="bluesky-handle" class="block text-sm font-medium text-gray-700 mb-1">
									Bluesky Handle
								</label>
								<input
									type="text"
									id="bluesky-handle"
									name="handle"
									required
									class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
									placeholder="@yourhandle.bsky.social"
								/>
								<p class="mt-1 text-xs text-gray-500">
									Enter your full Bluesky handle (e.g., @alice.bsky.social)
								</p>
							</div>
							<button
								type="submit"
								id="connect-button"
								class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
							>
								Connect with Bluesky
							</button>
						</form>
						
						<div class="mt-6 pt-6 border-t border-gray-200">
							<p class="text-sm text-gray-600 text-center">
								By connecting, you agree to authenticate with your Bluesky account.
							</p>
						</div>
					</div>

					<!-- Error Message -->
					<div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
						<p class="text-sm font-medium">Authentication failed</p>
						<p class="text-xs mt-1">Please check your handle and try again.</p>
					</div>

					<!-- Loading State -->
					<div id="loading-state" class="hidden">
						<div class="flex items-center justify-center space-x-2">
							<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
							<span class="text-gray-600">Redirecting to Bluesky...</span>
						</div>
					</div>
				</div>

				<div class="mt-8 text-center">
					<p class="text-xs text-gray-500">
						Don't have a Bluesky account? 
						<a href="https://bsky.app" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium">
							Sign up here
						</a>
					</p>
				</div>
			</div>
		</div>

		<script>
			// Check for error in URL
			const urlParams = new URLSearchParams(window.location.search);
			const error = urlParams.get('error');
			if (error === 'auth_failed') {
				const errorMessage = document.getElementById('error-message');
				errorMessage?.classList.remove('hidden');
			}

			// Handle Bluesky authentication
			const form = document.getElementById('bluesky-auth-form');
			const connectButton = document.getElementById('connect-button');
			const loadingState = document.getElementById('loading-state');
			const loginForm = document.getElementById('login-form');
			const errorMessage = document.getElementById('error-message');

			form?.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const formData = new FormData(form);
				let handle = formData.get('handle')?.toString() || '';
				
				// Clean up handle format
				handle = handle.trim();
				if (!handle.startsWith('@')) {
					handle = '@' + handle;
				}
				if (!handle.includes('.')) {
					handle = handle + '.bsky.social';
				}
				
				// Show loading state
				loginForm?.classList.add('hidden');
				errorMessage?.classList.add('hidden');
				loadingState?.classList.remove('hidden');
				
				try {
					// Use the simple OAuth endpoint
					const response = await fetch('/api/auth/bluesky-simple', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ handle: handle.substring(1) }), // Remove @ for API
					});
					
					const data = await response.json();
					
					if (!response.ok) {
						throw new Error(data.error || 'Failed to initiate authentication');
					}
					
					// Redirect to Bluesky OAuth
					if (data.authUrl) {
						window.location.href = data.authUrl;
					} else {
						throw new Error('No authorization URL received');
					}
				} catch (error) {
					console.error('Authentication error:', error);
					loadingState?.classList.add('hidden');
					loginForm?.classList.remove('hidden');
					errorMessage?.classList.remove('hidden');
					
					const errorDiv = document.getElementById('error-message');
					if (errorDiv) {
						errorDiv.innerHTML = `
							<p class="text-sm font-medium">Authentication Error</p>
							<p class="text-xs mt-1">${error.message || 'Failed to connect with Bluesky'}</p>
						`;
					}
				}
			});
		</script>
	</body>
</html>
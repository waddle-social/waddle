# Flux Cluster Configurations

This directory contains Flux GitOps configurations for managing Kubernetes cluster resources. Each subdirectory represents a deployment environment (production, staging, etc.).

## Table of Contents

- [Purpose](#purpose)
- [Directory Structure](#directory-structure)
- [Flux Bootstrap Process](#flux-bootstrap-process)
- [Environment Management](#environment-management)
- [Kustomization Dependencies](#kustomization-dependencies)
- [GitOps Workflow](#gitops-workflow)
- [Common Commands](#common-commands)
- [Troubleshooting](#troubleshooting)
- [Security Notes](#security-notes)

## Purpose

The `clusters/` directory serves as the per-environment entry point for Flux GitOps. It contains:

- **Flux System Configuration:** Auto-generated controllers and CRDs
- **Environment-Specific Kustomizations:** References to `infrastructure-k8s/` and `apps/`
- **Dependency Management:** Ordering between infrastructure and applications

**Separation of Concerns:**
- `clusters/` → Environment-specific Flux orchestration
- `infrastructure-k8s/` → Reusable infrastructure component manifests
- `apps/` → Application manifests and configurations

## Directory Structure

```
clusters/
├── README.md                           # This file
└── production/                         # Production environment
    ├── flux-system/                    # Auto-generated by flux bootstrap
    │   ├── gotk-components.yaml        # Flux controllers and CRDs
    │   ├── gotk-sync.yaml              # GitRepository and root Kustomization
    │   └── kustomization.yaml          # Kustomize aggregation
    ├── infrastructure/                 # Infrastructure Kustomizations
    │   ├── kustomization.yaml          # Aggregates all infrastructure resources
    │   ├── cilium.yaml                 # Cilium CNI Kustomization
    │   ├── cilium-helmrelease.yaml     # Cilium HelmRelease
    │   ├── cilium-helmrepo.yaml        # Cilium Helm repository
    │   ├── gateway-api-crds.yaml       # Gateway API CRDs Kustomization
    │   ├── storage.yaml                # Proxmox CSI Kustomization
    │   ├── storage-helmrelease.yaml    # Proxmox CSI HelmRelease
    │   └── storage-helmrepo.yaml       # Proxmox CSI Helm repository
    ├── apps/                           # Application Kustomizations
    │   └── kustomization.yaml          # Aggregates all app resources
    ├── infrastructure.yaml             # Root Kustomization for infrastructure
    └── apps.yaml                       # Root Kustomization for apps
```

## Flux Bootstrap Process

### Prerequisites

1. **Git repository** initialized and pushed to GitHub/GitLab
2. **GitHub/GitLab token** with repository write access
3. **kubectl access** to the target cluster
4. **Flux CLI** installed (`brew install fluxcd/tap/flux`)

### Bootstrap Command

```bash
flux bootstrap github \
  --owner=<github-org-or-username> \
  --repository=waddle-infra \
  --path=clusters/production \
  --personal
```

**What happens during bootstrap:**

1. Flux CLI connects to GitHub and creates/updates the repository
2. Installs Flux controllers in `flux-system` namespace:
   - source-controller (manages GitRepository, HelmRepository, OCIRepository)
   - kustomize-controller (manages Kustomization resources)
   - helm-controller (manages HelmRelease resources)
   - notification-controller (manages alerts and webhooks)
3. Creates `flux-system/gotk-components.yaml` with all CRDs and controllers
4. Creates `flux-system/gotk-sync.yaml` with:
   - GitRepository pointing to your repository
   - Kustomization watching `clusters/production/`
5. Commits and pushes the flux-system configuration
6. Flux begins reconciling resources from the repository

### Verification

```bash
# Check Flux is installed
flux check

# Check GitRepository source
flux get sources git

# Check all Kustomizations
flux get kustomizations

# Check Helm releases
flux get helmreleases -A
```

## Environment Management

### Adding a New Environment (e.g., Staging)

1. **Create environment directory:**
   ```bash
   mkdir -p clusters/staging/{infrastructure,apps}
   ```

2. **Copy structure from production:**
   ```bash
   cp clusters/production/infrastructure.yaml clusters/staging/
   cp clusters/production/apps.yaml clusters/staging/
   cp -r clusters/production/infrastructure/ clusters/staging/infrastructure/
   cp -r clusters/production/apps/ clusters/staging/apps/
   ```

3. **Customize for staging:**
   - Modify resource limits (smaller instances)
   - Use different Helm values (e.g., fewer replicas)
   - Reference staging-specific secrets

4. **Bootstrap Flux for staging cluster:**
   ```bash
   flux bootstrap github \
     --owner=<github-org> \
     --repository=waddle-infra \
     --path=clusters/staging \
     --context=staging-cluster
   ```

### Environment-Specific Overlays

Use Kustomize patches for environment differences:

```yaml
# clusters/staging/infrastructure/cilium.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cilium
  namespace: flux-system
spec:
  path: ./infrastructure-k8s/cilium
  # Override with staging-specific patches
  patches:
    - patch: |
        - op: replace
          path: /spec/replicas
          value: 1
      target:
        kind: Deployment
        name: cilium-operator
```

## Kustomization Dependencies

Flux Kustomizations support `dependsOn` for ordering:

```yaml
# apps.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: apps
spec:
  dependsOn:
    - name: infrastructure
  # ... rest of spec
```

**Dependency Chain:**
```
flux-system (root)
    └── infrastructure (Cilium, storage, cert-manager, etc.)
            └── apps (SpiceDB, observability, custom apps)
```

**Why Dependencies Matter:**
- Applications require networking (Cilium) to be ready
- Applications may need persistent storage (Proxmox CSI)
- Applications may need TLS certificates (cert-manager)
- Applications may need database operators (CloudNativePG)

## GitOps Workflow

### Making Changes

1. **Edit YAML files** in `clusters/`, `apps/`, or `infrastructure-k8s/`
2. **Commit and push** to the repository
3. **Flux auto-reconciles** within the configured interval (1-10 minutes)

### Manual Reconciliation

Force immediate sync when needed:

```bash
# Reconcile a specific Kustomization
flux reconcile kustomization infrastructure --with-source

# Reconcile a HelmRelease
flux reconcile helmrelease cilium -n kube-system

# Reconcile the GitRepository source
flux reconcile source git flux-system
```

### Suspending Reconciliation

Temporarily pause reconciliation for debugging:

```bash
# Suspend
flux suspend kustomization infrastructure

# Resume
flux resume kustomization infrastructure
```

### Viewing Changes Before Apply

```bash
# Preview what will be applied
flux diff kustomization infrastructure
```

## Common Commands

### Status Commands

```bash
# Overall Flux status
flux get all

# Kustomization status
flux get kustomizations

# HelmRelease status
flux get helmreleases -A

# GitRepository status
flux get sources git

# HelmRepository status
flux get sources helm
```

### Debugging Commands

```bash
# View Flux controller logs
flux logs --level=error --all-namespaces

# View specific controller logs
flux logs --kind=Kustomization --name=infrastructure

# Describe a Kustomization
kubectl describe kustomization infrastructure -n flux-system

# Describe a HelmRelease
kubectl describe helmrelease cilium -n kube-system
```

### Export Commands

```bash
# Export Kustomization YAML
flux export kustomization infrastructure > backup-infra.yaml

# Export HelmRelease YAML
flux export helmrelease cilium -n kube-system > backup-cilium.yaml
```

## Troubleshooting

### Kustomization Stuck in "Not Ready"

**Symptoms:** Kustomization shows `Ready: False` for extended periods.

**Check events:**
```bash
kubectl describe kustomization <name> -n flux-system
```

**Common causes:**
- Source not ready (GitRepository/HelmRepository issues)
- Dependency not met (check `dependsOn`)
- Invalid YAML syntax
- Resource validation failure

### HelmRelease Failed

**Symptoms:** HelmRelease shows failed status.

**Check Helm release status:**
```bash
kubectl describe helmrelease <name> -n <namespace>
helm list -A
helm history <release-name> -n <namespace>
```

**Common causes:**
- Invalid Helm values
- Chart version not found
- CRDs missing (install CRDs before HelmRelease)
- Resource already exists (use `install.createNamespace: true`)

### Source Not Found

**Symptoms:** `source not found` errors in logs.

**Verify sources:**
```bash
flux get sources git
flux get sources helm
```

**Common causes:**
- Repository URL incorrect
- Authentication token expired
- Network connectivity issues

### Resource Already Exists

**Symptoms:** `resource already exists` during apply.

**Resolution options:**
1. Set `spec.force: true` in Kustomization (use with caution)
2. Manually adopt existing resources with labels
3. Delete existing resources before Flux deployment

### Health Check Failures

**Symptoms:** Kustomization fails health checks.

**Debug:**
```bash
# Check the actual resource status
kubectl get pods -n <namespace>
kubectl describe pod <pod-name> -n <namespace>
```

**Adjust health check timeout:**
```yaml
spec:
  timeout: 10m  # Increase from default 5m
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: <deployment>
      namespace: <namespace>
```

## Security Notes

### RBAC and Service Accounts

Flux controllers run with their own service accounts in `flux-system` namespace:
- `source-controller` - reads Git/Helm repositories
- `kustomize-controller` - applies Kustomizations
- `helm-controller` - installs Helm releases
- `notification-controller` - sends notifications

**Review permissions:**
```bash
kubectl get clusterrolebindings | grep flux
kubectl describe clusterrolebinding flux-system-kustomize-controller
```

### Secret Management

**Options for managing secrets:**

1. **Sealed Secrets:** Encrypt secrets client-side, store encrypted in Git
   ```bash
   kubeseal --format yaml < secret.yaml > sealed-secret.yaml
   ```

2. **External Secrets:** Fetch from Vault, AWS Secrets Manager, etc.
   ```yaml
   apiVersion: external-secrets.io/v1beta1
   kind: ExternalSecret
   spec:
     secretStoreRef:
       name: vault-backend
   ```

3. **SOPS:** Mozilla SOPS with age/gpg encryption
   ```bash
   sops --encrypt secret.yaml > secret.enc.yaml
   ```

**Never commit plain-text secrets to Git.**

### Audit Logging

All Flux reconciliation events are logged. View with:

```bash
# Flux controller logs
flux logs --all-namespaces

# Kubernetes events
kubectl get events -n flux-system --sort-by='.lastTimestamp'
```

### Git Repository Access

- Use deploy keys with read-only access when possible
- Rotate tokens regularly
- Use fine-grained GitHub tokens with minimal permissions

## Files in This Directory

| File/Directory | Description |
|----------------|-------------|
| `README.md` | This documentation file |
| `production/` | Production environment configuration |
| `production/flux-system/` | Auto-generated Flux controllers (do not edit manually) |
| `production/infrastructure/` | Infrastructure component Kustomizations |
| `production/apps/` | Application Kustomizations |
| `production/infrastructure.yaml` | Root Kustomization for infrastructure |
| `production/apps.yaml` | Root Kustomization for apps |

## References

- [Flux Documentation](https://fluxcd.io/docs/)
- [Flux Kustomization API](https://fluxcd.io/flux/components/kustomize/kustomizations/)
- [Flux HelmRelease API](https://fluxcd.io/flux/components/helm/helmreleases/)
- [Flux Multi-tenancy](https://fluxcd.io/flux/installation/configuration/multitenancy/)
- [Flux Monitoring](https://fluxcd.io/flux/monitoring/)
- [GitOps Toolkit](https://fluxcd.io/flux/components/)

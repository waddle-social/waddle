# =============================================================================
# FLUX HELMRELEASE: ALERTMANAGER
# =============================================================================
#
# Phase 15: Alertmanager for alert routing and notification
#
# Chart: prometheus-community/alertmanager
#
# Dependencies:
# - Prometheus Operator (provides CRDs and ServiceMonitor support)
# - Observability namespace exists
# - alertmanager-config Secret must be created manually
#
# =============================================================================
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alertmanager
  namespace: flux-system
spec:
  interval: 1h
  chart:
    spec:
      chart: alertmanager
      version: "1.12.x"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      interval: 1h

  targetNamespace: observability
  
  install:
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  # Dependencies
  dependsOn:
    - name: prometheus-operator
      namespace: flux-system

  # Values from ConfigMap
  valuesFrom:
    - kind: ConfigMap
      name: alertmanager-values
      valuesKey: values.yaml

  # Health checks
  postRenderers: []

---
# ConfigMap for Alertmanager Helm values
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-values
  namespace: flux-system
data:
  values.yaml: |
    # High availability with gossip clustering
    replicaCount: 3

    image:
      repository: quay.io/prometheus/alertmanager
      tag: v0.27.0
      pullPolicy: IfNotPresent

    # Resource limits
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 512Mi

    # Persistent storage
    persistence:
      enabled: true
      storageClass: proxmox-csi
      accessModes:
        - ReadWriteOnce
      size: 10Gi

    # Data retention
    retention: 120h

    # Use external Secret for configuration
    configmapReload:
      enabled: true

    # Disable default config - use alertmanager-config Secret instead
    config:
      enabled: false

    # Load configuration from Secret
    # Secret must be created manually with key 'alertmanager.yaml'
    # See docs/observability-setup.md for instructions
    configFrom:
      - secretRef:
          name: alertmanager-config
          key: alertmanager.yaml

    # Service configuration
    service:
      type: ClusterIP
      port: 9093

    # Ingress disabled
    ingress:
      enabled: false

    # Pod scheduling
    nodeSelector:
      node-role.kubernetes.io/control-plane: ""

    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule

    # Pod anti-affinity for HA
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - alertmanager
              topologyKey: kubernetes.io/hostname

    # Security context
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      runAsNonRoot: true

    containerSecurityContext:
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

    # ServiceMonitor for Prometheus scraping
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

    # Pod disruption budget for HA
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

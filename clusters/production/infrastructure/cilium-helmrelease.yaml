# Cilium HelmRelease
# ==================
#
# Deploys Cilium CNI via Helm using values from infrastructure-k8s/cilium/.
# Migrates the manually-installed Cilium (Phase 6) to Flux management.
#
# Chart: cilium/cilium
# Version: 1.18.4
# Namespace: kube-system
#
# Features enabled:
#   - kube-proxy replacement (eBPF)
#   - Gateway API controller
#   - Hubble observability
#   - Native routing mode
#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  # Reference the Cilium Helm repository
  chart:
    spec:
      chart: cilium
      version: "1.18.4"
      sourceRef:
        kind: HelmRepository
        name: cilium
        namespace: flux-system

  # Reconcile Helm release hourly (stable component)
  interval: 1h

  # Use Helm values from the ConfigMap generated by kustomization.yaml
  valuesFrom:
    - kind: ConfigMap
      name: cilium-values
      valuesKey: values.yaml

  # Install configuration
  install:
    # kube-system namespace already exists
    createNamespace: false

    # Remediation on install failure
    remediation:
      retries: 3

    # Replace existing resources if needed (for migration from manual install)
    replace: false

  # Upgrade configuration
  upgrade:
    # Clean up old resources on upgrade
    cleanupOnFail: true

    # Remediation on upgrade failure
    remediation:
      retries: 3
      # Rollback on upgrade failure
      remediateLastFailure: true

  # Rollback configuration
  rollback:
    # Keep rollback history
    cleanupOnFail: true

  # Wait for all resources to be ready
  timeout: 10m

  # Note: Gateway API CRD dependency is handled at the Kustomization level
  # in cilium.yaml, not here. HelmRelease dependsOn only works with other
  # HelmReleases, not Kustomizations.

  # Values override (can be used for quick patches without editing ConfigMap)
  # values: {}

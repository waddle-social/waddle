# Infrastructure Components Kustomization
# =======================================
#
# This Kustomize file aggregates all infrastructure component resources.
# Referenced by clusters/production/infrastructure.yaml Flux Kustomization.
#
# Resource Order:
# 1. Gateway API CRDs (prerequisite for Cilium Gateway support)
# 2. Helm Repositories (required by HelmReleases)
# 3. HelmReleases and Kustomizations (actual deployments)
#
# Infrastructure components deployed:
# - Gateway API CRDs (Cilium prerequisite)
# - Cilium CNI (Phase 6)
# - Proxmox CSI Storage (Phase 7)
# - cert-manager (Phase 9)
# - Gateway API Ingress (Phase 10)
# - CloudNativePG (Phase 11)
# - Observability stack - LGTM (Phase 13)
#
# Future phases will add:
# - SpiceDB (Phase 12)
# - Alerting (Phase 14+)
#
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Gateway API CRDs - must be first (Cilium depends on these)
  - gateway-api-crds.yaml

  # Cilium CNI (Phase 6)
  - cilium-helmrepo.yaml
  - cilium-helmrelease.yaml
  - cilium.yaml

  # Proxmox CSI Storage (Phase 7)
  - storage-helmrepo.yaml
  - storage-helmrelease.yaml
  - storage.yaml

  # cert-manager (Phase 9)
  - cert-manager-helmrepo.yaml
  - cert-manager-helmrelease.yaml
  - cert-manager.yaml
  - cert-manager-clusterissuers.yaml

  # Gateway API Ingress (Phase 10)
  - gateway.yaml

  # CloudNativePG (Phase 11) - PostgreSQL operator
  # Depends on: Cilium (networking), Proxmox CSI (storage)
  - cnpg-helmrepo.yaml
  - cnpg-helmrelease.yaml
  - cnpg.yaml

  # Observability Stack (Phase 13) - LGTM + OpenTelemetry
  # Depends on: Cilium (networking), Proxmox CSI (storage)
  # Components: Grafana, Loki, Tempo, Mimir, OpenTelemetry Collector, Prometheus Operator
  - observability-prometheus-operator-helmrepo.yaml
  - observability-grafana-helmrepo.yaml
  - observability-opentelemetry-helmrepo.yaml
  - observability-prometheus-operator-helmrelease.yaml
  - observability-loki-helmrelease.yaml
  - observability-tempo-helmrelease.yaml
  - observability-mimir-helmrelease.yaml
  - observability-opentelemetry-helmrelease.yaml
  - observability-grafana-helmrelease.yaml
  - observability.yaml
  - observability-servicemonitors.yaml
  - observability-dashboards.yaml

  # Network Policies (Phase 14) - Zero-trust networking
  # Depends on: Cilium (NetworkPolicy enforcement)
  - network-policies.yaml

  # Alerting (Phase 15) - PrometheusRules and Alertmanager
  # Depends on: Prometheus Operator (CRDs), Observability (namespace)
  - observability-alertmanager-helmrelease.yaml
  - observability-alerting.yaml

# =============================================================================
# Teleport TCP Application Access Configuration
# =============================================================================
#
# This configuration registers internal Talos nodes and Kubernetes API as
# TCP applications in Teleport, enabling secure access through the proxy.
#
# Installation:
#   1. Copy this file to the Teleport server:
#      scp docs/teleport-tcp-apps.yaml admin@teleport-vm:/tmp/
#
#   2. SSH to Teleport VM and merge with existing config:
#      sudo tee -a /etc/teleport.yaml < /tmp/teleport-tcp-apps.yaml
#
#   3. Or create as a separate config file:
#      sudo cp /tmp/teleport-tcp-apps.yaml /etc/teleport.d/talos-apps.yaml
#
#   4. Restart Teleport:
#      sudo systemctl restart teleport
#
#   5. Verify apps are registered:
#      tsh apps ls
#
# Usage:
#   # Login to Teleport
#   tsh login --proxy=teleport.waddle.social:443
#
#   # List available TCP apps
#   tsh apps ls
#
#   # Start a TCP tunnel to Talos CP1
#   tsh proxy app talos-cp1 -p 50001
#
#   # Then connect with talosctl using localhost
#   talosctl --talosconfig=./talosconfig -e 127.0.0.1:50001 health
#
# =============================================================================

# Add this to /etc/teleport.yaml under the existing configuration
# or create as /etc/teleport.d/talos-apps.yaml

app_service:
  enabled: true
  apps:
    # =========================================================================
    # Talos API Endpoints (Port 50000)
    # =========================================================================
    # Talos uses port 50000 for the machine API (apid).
    # Each control plane node needs its own TCP app registration.

    - name: talos-cp1
      description: "Talos Control Plane 1 - Machine API"
      uri: tcp://192.168.1.101:50000
      labels:
        env: production
        type: talos-api
        node: cp1
        role: control-plane

    - name: talos-cp2
      description: "Talos Control Plane 2 - Machine API"
      uri: tcp://192.168.1.102:50000
      labels:
        env: production
        type: talos-api
        node: cp2
        role: control-plane

    - name: talos-cp3
      description: "Talos Control Plane 3 - Machine API"
      uri: tcp://192.168.1.103:50000
      labels:
        env: production
        type: talos-api
        node: cp3
        role: control-plane

    # =========================================================================
    # Kubernetes API Endpoint (Port 6443)
    # =========================================================================
    # The Kubernetes API server runs on port 6443 on control plane nodes.
    # We expose CP1 as the primary endpoint (matches TALOS_CLUSTER_ENDPOINT).

    - name: kubernetes-api
      description: "Kubernetes API Server"
      uri: tcp://192.168.1.101:6443
      labels:
        env: production
        type: kubernetes
        service: api-server

    # =========================================================================
    # Optional: Worker Node Talos API
    # =========================================================================
    # Uncomment if you have worker nodes and need direct Talos API access.

    # - name: talos-worker1
    #   description: "Talos Worker 1 - Machine API"
    #   uri: tcp://192.168.1.104:50000
    #   labels:
    #     env: production
    #     type: talos-api
    #     node: worker1
    #     role: worker

    # =========================================================================
    # Optional: Proxmox API
    # =========================================================================
    # Uncomment to access Proxmox API through Teleport (alternative to web UI).

    # - name: proxmox-api
    #   description: "Proxmox VE API"
    #   uri: tcp://192.168.1.1:8006
    #   labels:
    #     env: production
    #     type: proxmox
    #     service: api

# =============================================================================
# Role Configuration for TCP App Access
# =============================================================================
#
# Users need appropriate roles to access TCP applications.
# Create a role file at /etc/teleport/roles/talos-access.yaml:
#
# kind: role
# version: v7
# metadata:
#   name: talos-access
# spec:
#   allow:
#     app_labels:
#       type: ["talos-api", "kubernetes"]
#     rules:
#       - resources: [app]
#         verbs: [read, list]
#
# Apply with: sudo tctl create -f /etc/teleport/roles/talos-access.yaml
# Add to user: sudo tctl users update <username> --set-roles=talos-access,access
#
# =============================================================================

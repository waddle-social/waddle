# Flux GitOps Workflow Guide

This guide covers the complete Flux GitOps workflow for managing the Talos Kubernetes cluster infrastructure and applications.

## Table of Contents

1. [Flux Architecture](#flux-architecture)
2. [Directory Structure](#directory-structure)
3. [Bootstrap Process](#bootstrap-process)
4. [GitOps Workflow](#gitops-workflow)
5. [Adding New Components](#adding-new-components)
6. [Troubleshooting](#troubleshooting)
7. [Security Best Practices](#security-best-practices)
8. [Multi-Environment Management](#multi-environment-management)
9. [Disaster Recovery](#disaster-recovery)
10. [Monitoring and Alerts](#monitoring-and-alerts)

## Flux Architecture

### Controllers

Flux consists of four main controllers that work together:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              flux-system namespace                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────┐      ┌─────────────────────┐                      │
│   │  Source Controller  │      │ Kustomize Controller│                      │
│   │                     │      │                     │                      │
│   │ - GitRepository     │─────▶│ - Kustomization     │─────▶ K8s Resources  │
│   │ - HelmRepository    │      │ - Reconciliation    │                      │
│   │ - OCIRepository     │      │ - Health checks     │                      │
│   └─────────────────────┘      └─────────────────────┘                      │
│              │                                                               │
│              ▼                                                               │
│   ┌─────────────────────┐      ┌─────────────────────┐                      │
│   │   Helm Controller   │      │Notification Controller                     │
│   │                     │      │                     │                      │
│   │ - HelmRelease       │      │ - Provider          │─────▶ Slack/Email    │
│   │ - Chart retrieval   │      │ - Alert             │                      │
│   │ - Install/Upgrade   │      │ - Receiver          │                      │
│   └─────────────────────┘      └─────────────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Source Controller

Manages sources of truth for Kubernetes manifests:

| Resource | Description | Example |
|----------|-------------|---------|
| GitRepository | Git repository containing manifests | waddle-infra repo |
| HelmRepository | Helm chart repository | Cilium, Proxmox CSI |
| OCIRepository | OCI artifacts (images as sources) | Gateway API CRDs |
| Bucket | S3-compatible bucket | Artifact storage |

### Kustomize Controller

Reconciles Kustomization resources:

- Builds manifests from Kustomize overlays
- Applies manifests to the cluster
- Monitors resource health
- Handles dependencies between Kustomizations

### Helm Controller

Manages Helm releases:

- Fetches charts from HelmRepository
- Installs/upgrades releases
- Handles rollbacks on failure
- Supports values from ConfigMaps/Secrets

### Notification Controller

Handles alerts and webhooks:

- Sends notifications on reconciliation events
- Receives webhooks to trigger reconciliation
- Supports Slack, Discord, MS Teams, email, etc.

## Directory Structure

### Monorepo Layout

```
waddle-infra/
├── clusters/                    # Per-environment Flux configurations
│   └── production/
│       ├── flux-system/         # Auto-generated by bootstrap
│       │   ├── gotk-components.yaml
│       │   ├── gotk-sync.yaml
│       │   └── kustomization.yaml
│       ├── infrastructure/      # Infrastructure Kustomizations
│       │   ├── kustomization.yaml
│       │   ├── cilium.yaml
│       │   ├── cilium-helmrelease.yaml
│       │   └── storage.yaml
│       ├── apps/               # Application Kustomizations
│       │   └── kustomization.yaml
│       ├── infrastructure.yaml # Root infra Kustomization
│       └── apps.yaml           # Root apps Kustomization
├── infrastructure-k8s/         # Reusable infrastructure manifests
│   ├── cilium/
│   │   ├── kustomization.yaml
│   │   └── helm-values.yaml
│   └── storage/
│       ├── kustomization.yaml
│       └── helm-values.yaml
└── apps/                       # Application manifests
    └── .gitkeep
```

### Separation of Concerns

| Directory | Purpose | Who Edits |
|-----------|---------|-----------|
| `clusters/<env>/flux-system/` | Flux controllers and bootstrap | Bootstrap only |
| `clusters/<env>/infrastructure/` | Flux Kustomizations for infra | Platform team |
| `clusters/<env>/apps/` | Flux Kustomizations for apps | App teams |
| `infrastructure-k8s/` | Base infrastructure manifests | Platform team |
| `apps/` | Base application manifests | App teams |

### Dependency Management

Flux uses `dependsOn` to order reconciliation:

```
flux-system (root)
    │
    ├── infrastructure.yaml
    │       │
    │       ├── gateway-api-crds (no deps)
    │       │
    │       ├── cilium (depends on: gateway-api-crds)
    │       │
    │       └── storage (depends on: cilium)
    │
    └── apps.yaml (depends on: infrastructure)
            │
            ├── spicedb (depends on: cloudnative-pg)
            │
            └── observability (no additional deps)
```

## Bootstrap Process

### Prerequisites

1. **Git repository** created and accessible
2. **GitHub/GitLab personal access token** with repo permissions
3. **kubectl** configured with cluster admin access
4. **Flux CLI** installed:
   ```bash
   # macOS
   brew install fluxcd/tap/flux

   # Linux
   curl -s https://fluxcd.io/install.sh | sudo bash
   ```

### Bootstrap Command

```bash
# Export GitHub token (create at github.com/settings/tokens)
export GITHUB_TOKEN=<your-github-pat>

# Bootstrap Flux
flux bootstrap github \
  --owner=<github-org-or-username> \
  --repository=waddle-infra \
  --path=clusters/production \
  --personal \
  --components-extra=image-reflector-controller,image-automation-controller
```

**Parameters explained:**
- `--owner`: GitHub organization or username
- `--repository`: Repository name
- `--path`: Path within repo for this cluster
- `--personal`: Use personal access token (vs. deploy key)
- `--components-extra`: Optional additional controllers

### What Gets Created

1. **flux-system namespace** with controllers
2. **GitRepository** pointing to waddle-infra
3. **Kustomization** watching `clusters/production/`
4. **Committed files** in `clusters/production/flux-system/`:
   - `gotk-components.yaml`: All Flux CRDs and controllers
   - `gotk-sync.yaml`: GitRepository and root Kustomization
   - `kustomization.yaml`: Kustomize aggregation

### Verification

```bash
# Check Flux installation
flux check

# Check sources
flux get sources git
# NAME         REVISION     SUSPENDED  READY  MESSAGE
# flux-system  main@sha1:x  False      True   stored artifact for revision

# Check kustomizations
flux get kustomizations
# NAME            REVISION     SUSPENDED  READY  MESSAGE
# flux-system     main@sha1:x  False      True   Applied revision
# infrastructure  main@sha1:x  False      True   Applied revision
# apps            main@sha1:x  False      True   Applied revision

# Check helm releases
flux get helmreleases -A
# NAMESPACE    NAME         REVISION  SUSPENDED  READY  MESSAGE
# kube-system  cilium       1.18.4    False      True   Helm install succeeded
# csi-proxmox  proxmox-csi  0.13.0    False      True   Helm install succeeded
```

## GitOps Workflow

### Making Changes

**Standard workflow:**

1. **Edit YAML files** in your local clone
2. **Validate changes** locally:
   ```bash
   # Test kustomize build
   kustomize build clusters/production/infrastructure/

   # Validate Kubernetes manifests
   kubeconform -summary clusters/production/infrastructure/
   ```
3. **Commit and push**:
   ```bash
   git add .
   git commit -m "Update Cilium to v1.18.5"
   git push
   ```
4. **Flux reconciles** within the configured interval (1-10 minutes)

### Manual Reconciliation

Force immediate sync when needed:

```bash
# Reconcile specific Kustomization
flux reconcile kustomization infrastructure --with-source

# Reconcile HelmRelease
flux reconcile helmrelease cilium -n kube-system

# Reconcile all
flux reconcile source git flux-system
```

### Suspending Reconciliation

Pause reconciliation for debugging or maintenance:

```bash
# Suspend
flux suspend kustomization infrastructure

# Make manual changes via kubectl...

# Resume
flux resume kustomization infrastructure
```

### Previewing Changes

Before pushing, preview what will change:

```bash
# Show diff for a Kustomization
flux diff kustomization infrastructure --path ./clusters/production/infrastructure

# Dry-run apply
kubectl apply --dry-run=server -k clusters/production/infrastructure/
```

### Rolling Back Changes

```bash
# Git revert (recommended)
git revert HEAD
git push

# Or: Helm rollback (temporary until next reconcile)
helm rollback cilium 1 -n kube-system
```

## Adding New Components

### Infrastructure Component

1. **Create base manifests** in `infrastructure-k8s/<component>/`:
   ```yaml
   # infrastructure-k8s/cert-manager/kustomization.yaml
   apiVersion: kustomize.config.k8s.io/v1beta1
   kind: Kustomization
   namespace: cert-manager
   configMapGenerator:
     - name: cert-manager-values
       files:
         - values.yaml=helm-values.yaml
       options:
         disableNameSuffixHash: true
   ```

2. **Create Flux resources** in `clusters/production/infrastructure/`:
   ```yaml
   # cert-manager-helmrepo.yaml
   apiVersion: source.toolkit.fluxcd.io/v1
   kind: HelmRepository
   metadata:
     name: cert-manager
     namespace: flux-system
   spec:
     url: https://charts.jetstack.io
     interval: 1h
   ```

   ```yaml
   # cert-manager-helmrelease.yaml
   apiVersion: helm.toolkit.fluxcd.io/v2
   kind: HelmRelease
   metadata:
     name: cert-manager
     namespace: cert-manager
   spec:
     chart:
       spec:
         chart: cert-manager
         version: "v1.14.0"
         sourceRef:
           kind: HelmRepository
           name: cert-manager
           namespace: flux-system
     interval: 1h
     install:
       createNamespace: true
       crds: CreateReplace
     valuesFrom:
       - kind: ConfigMap
         name: cert-manager-values
         valuesKey: values.yaml
   ```

3. **Add to kustomization.yaml**:
   ```yaml
   resources:
     # ... existing
     - cert-manager-helmrepo.yaml
     - cert-manager-helmrelease.yaml
     - cert-manager.yaml
   ```

### Application

1. **Create manifests** in `apps/<app-name>/`
2. **Create Kustomization** in `clusters/production/apps/`
3. **Add to** `clusters/production/apps/kustomization.yaml`

See `apps/README.md` for detailed instructions.

## Troubleshooting

### Common Issues

#### Kustomization Not Ready

**Check status:**
```bash
kubectl describe kustomization infrastructure -n flux-system
```

**Common causes:**
- Source not ready (GitRepository issues)
- Dependency not met
- Invalid YAML syntax
- Resource validation failure

#### HelmRelease Failed

**Check Helm history:**
```bash
helm history cilium -n kube-system
```

**Check release status:**
```bash
kubectl describe helmrelease cilium -n kube-system
```

**Common causes:**
- Invalid values
- Chart not found
- CRDs missing
- Resource conflicts

#### Source Not Found

**Verify sources:**
```bash
flux get sources all
```

**Common causes:**
- Repository URL incorrect
- Authentication failed
- Network issues

### Debugging Commands

```bash
# View all Flux resources
flux get all

# View controller logs
flux logs --level=error --all-namespaces

# View specific controller logs
kubectl logs -n flux-system deploy/source-controller
kubectl logs -n flux-system deploy/kustomize-controller
kubectl logs -n flux-system deploy/helm-controller

# Describe resources
kubectl describe kustomization -n flux-system
kubectl describe helmrelease -n kube-system

# View events
kubectl get events -n flux-system --sort-by='.lastTimestamp'
```

### Health Check Failures

**Adjust timeout:**
```yaml
spec:
  timeout: 10m  # Increase from default 5m
```

**Check actual resource:**
```bash
kubectl get pods -n <namespace>
kubectl describe pod <pod> -n <namespace>
```

## Security Best Practices

### Secret Management

**Never commit plain-text secrets to Git.**

**Option 1: Sealed Secrets**
```bash
# Install kubeseal CLI
brew install kubeseal

# Encrypt secret
kubeseal --format yaml < secret.yaml > sealed-secret.yaml

# Commit sealed-secret.yaml (safe to commit)
git add sealed-secret.yaml
```

**Option 2: External Secrets**
```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: database-credentials
  data:
    - secretKey: password
      remoteRef:
        key: database/credentials
        property: password
```

**Option 3: SOPS**
```bash
# Encrypt with age
sops --encrypt --age <age-public-key> secret.yaml > secret.enc.yaml

# Configure Flux decryption
flux create secret sops age-key \
  --namespace=flux-system \
  --private-key=<age-private-key>
```

### RBAC

Review Flux service account permissions:

```bash
# List ClusterRoleBindings
kubectl get clusterrolebindings | grep flux

# Describe permissions
kubectl describe clusterrole flux-system-kustomize-controller
```

### Git Repository Security

- Use deploy keys with read-only access when possible
- Rotate tokens regularly
- Enable branch protection
- Require pull request reviews

### Audit Trail

All changes tracked via Git history:

```bash
# View commit history
git log --oneline clusters/production/

# View who changed what
git blame clusters/production/infrastructure.yaml
```

## Multi-Environment Management

### Creating Staging Environment

1. **Create directory structure:**
   ```bash
   mkdir -p clusters/staging/{infrastructure,apps}
   ```

2. **Copy and customize:**
   ```bash
   cp clusters/production/infrastructure.yaml clusters/staging/
   cp clusters/production/apps.yaml clusters/staging/
   ```

3. **Bootstrap for staging cluster:**
   ```bash
   flux bootstrap github \
     --owner=<org> \
     --repository=waddle-infra \
     --path=clusters/staging \
     --context=staging-cluster
   ```

### Environment-Specific Values

Use Kustomize patches:

```yaml
# clusters/staging/infrastructure/cilium.yaml
spec:
  patches:
    - patch: |
        - op: replace
          path: /spec/replicas
          value: 1
      target:
        kind: Deployment
```

Or separate Helm values files:

```
infrastructure-k8s/cilium/
├── helm-values.yaml           # Base values
├── helm-values-staging.yaml   # Staging overrides
└── helm-values-production.yaml # Production overrides
```

### Promoting Changes

**Git-based promotion:**
1. Test changes in staging branch/cluster
2. Merge to main branch
3. Production Flux auto-reconciles

## Disaster Recovery

### Backup Strategy

**Git is your backup.** The entire cluster state is defined in the repository.

**Additional backups:**
- Secrets: Backup encrypted secrets or external secret store
- PersistentVolumes: Use Velero or storage-level snapshots
- Flux state: Exported via `flux export`

### Recovery Procedure

1. **Rebuild cluster** (Talos reinstall if needed)
2. **Re-bootstrap Flux:**
   ```bash
   flux bootstrap github \
     --owner=<org> \
     --repository=waddle-infra \
     --path=clusters/production
   ```
3. **Flux reconciles** all resources from Git
4. **Restore secrets** from backup
5. **Restore data** from PV backups

### Testing Recovery

Regularly test recovery in staging:

```bash
# Delete Flux
flux uninstall

# Re-bootstrap
flux bootstrap github ...

# Verify all resources restored
flux get all
kubectl get pods -A
```

## Monitoring and Alerts

### Prometheus Metrics

Flux controllers expose Prometheus metrics:

```bash
# Port-forward to source-controller
kubectl port-forward -n flux-system deploy/source-controller 8080:8080

# View metrics
curl localhost:8080/metrics
```

**Key metrics:**
- `gotk_reconcile_duration_seconds`: Reconciliation duration
- `gotk_reconcile_condition`: Current condition status
- `controller_runtime_reconcile_total`: Total reconciliations

### Grafana Dashboards

Install Flux Grafana dashboards:

```yaml
# clusters/production/infrastructure/flux-monitoring.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: flux-monitoring
spec:
  path: ./manifests/monitoring/monitoring-config
  sourceRef:
    kind: GitRepository
    name: flux-monitoring
  interval: 1h
```

### Notifications

Configure Slack alerts:

```yaml
# clusters/production/flux-system/notifications.yaml
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Provider
metadata:
  name: slack
  namespace: flux-system
spec:
  type: slack
  channel: "#flux-alerts"
  secretRef:
    name: slack-webhook-url
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Alert
metadata:
  name: on-call
  namespace: flux-system
spec:
  providerRef:
    name: slack
  eventSeverity: error
  eventSources:
    - kind: Kustomization
      name: "*"
    - kind: HelmRelease
      name: "*"
```

## References

- [Flux Documentation](https://fluxcd.io/docs/)
- [Flux Components](https://fluxcd.io/flux/components/)
- [Flux Kustomization API](https://fluxcd.io/flux/components/kustomize/kustomizations/)
- [Flux HelmRelease API](https://fluxcd.io/flux/components/helm/helmreleases/)
- [Flux Multi-tenancy](https://fluxcd.io/flux/installation/configuration/multitenancy/)
- [Flux Monitoring](https://fluxcd.io/flux/monitoring/)
- [Flux Security](https://fluxcd.io/flux/security/)
- [GitOps Toolkit](https://fluxcd.io/flux/components/)

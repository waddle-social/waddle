#cloud-config
hostname: teleport
manage_etc_hosts: true
package_update: false
package_upgrade: false

users:
  - name: deploy
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${ssh_public_key}

write_files:
  - path: /etc/teleport.yaml
    content: |
      version: v3
      teleport:
        nodename: teleport
        data_dir: /var/lib/teleport
        log:
          output: stderr
          severity: INFO
      auth_service:
        enabled: true
        listen_addr: 0.0.0.0:3025
        cluster_name: teleport.${domain}
        authentication:
          type: github
      proxy_service:
        enabled: true
        web_listen_addr: 0.0.0.0:3080
        tunnel_listen_addr: 0.0.0.0:3024
        public_addr: teleport.${domain}:443
        acme:
          enabled: true
          email: admin@${domain}
      ssh_service:
        enabled: true
      app_service:
        enabled: true
        apps:
          - name: proxmox
            uri: https://${proxmox_host_ip}:8006
            public_addr: proxmox.${domain}
            insecure_skip_verify: true
    owner: root:root
    permissions: "0600"

  - path: /tmp/infra-admin-role.yaml
    content: |
      kind: role
      version: v7
      metadata:
        name: infra-admin
      spec:
        allow:
          logins:
            - deploy
            - root
          node_labels:
            '*': '*'
          app_labels:
            '*': '*'
          kubernetes_labels:
            '*': '*'
          kubernetes_groups:
            - system:masters
          kubernetes_resources:
            - kind: '*'
              namespace: '*'
              name: '*'
              verbs: ['*']
          rules:
            - resources: ['*']
              verbs: ['*']
    owner: root:root
    permissions: "0600"

  - path: /tmp/github-connector.yaml
    content: |
      kind: github
      version: v3
      metadata:
        name: github
      spec:
        client_id: ${github_client_id}
        client_secret: ${github_client_secret}
        display: GitHub
        redirect_url: https://teleport.${domain}/v1/webapi/github/callback
        teams_to_roles:
          - organization: ${github_org}
            team: infra
            roles:
              - infra-admin
    owner: root:root
    permissions: "0600"

runcmd:
  - apt-get update
  - apt-get install -y qemu-guest-agent curl gnupg
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - curl -fsSL https://goteleport.com/static/install.sh | bash -s ${teleport_major_version}
  - systemctl enable teleport
  - systemctl start teleport
  - sleep 10
  - tctl create /tmp/infra-admin-role.yaml || true
  - tctl create /tmp/github-connector.yaml || true
  - rm -f /tmp/infra-admin-role.yaml /tmp/github-connector.yaml
  - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
  - systemctl restart sshd

{{- if and .Values.secret.create (not .Values.secret.existingSecret) }}
{{- $secretName := include "waddle-server.secretName" . -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $existingSessionKey := "" -}}
{{- $existingAuthProvidersJson := "" -}}
{{- if and $existing $existing.data (hasKey $existing.data "WADDLE_SESSION_KEY") -}}
{{- $existingSessionKey = (index $existing.data "WADDLE_SESSION_KEY" | b64dec) -}}
{{- end -}}
{{- if and $existing $existing.data (hasKey $existing.data "WADDLE_AUTH_PROVIDERS_JSON") -}}
{{- $existingAuthProvidersJson = (index $existing.data "WADDLE_AUTH_PROVIDERS_JSON" | b64dec) -}}
{{- end -}}
{{- $sessionKey := coalesce .Values.secret.sessionKey $existingSessionKey -}}
{{- $authProvidersJson := coalesce .Values.secret.authProvidersJson $existingAuthProvidersJson -}}
{{- if eq $sessionKey "" -}}
{{- $sessionKey = randAlphaNum 64 -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "waddle-server.labels" . | nindent 4 }}
type: Opaque
stringData:
  WADDLE_SESSION_KEY: {{ $sessionKey | quote }}
  {{- if $authProvidersJson }}
  WADDLE_AUTH_PROVIDERS_JSON: {{ $authProvidersJson | quote }}
  {{- end }}
  {{- if .Values.secret.githubToken }}
  GITHUB_TOKEN: {{ .Values.secret.githubToken | quote }}
  {{- end }}
{{- end }}

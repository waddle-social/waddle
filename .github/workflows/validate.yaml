# Kubernetes Manifest Validation Workflow
# =======================================
#
# Validates Kubernetes manifests and Kustomize builds on pull requests.
# Provides early feedback before changes are merged and reconciled by Flux.
#
# Jobs:
# 1. Kustomize Build: Verify all kustomization.yaml files build successfully
# 2. Kubernetes Validation: Validate manifests against K8s schemas
# 3. YAML Linting: Check YAML syntax and style
# 4. Flux Validation: Verify Flux-specific resources
#
name: Validate Kubernetes Manifests

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'clusters/**'
      - 'apps/**'
      - 'infrastructure-k8s/**'
      - '.github/workflows/validate.yaml'
  push:
    branches:
      - main
      - master
    paths:
      - 'clusters/**'
      - 'apps/**'
      - 'infrastructure-k8s/**'

env:
  KUBERNETES_VERSION: "1.30.0"

jobs:
  # Job 1: Validate YAML syntax and style
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            clusters/
            apps/
            infrastructure-k8s/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 200
                level: warning
              comments:
                min-spaces-from-content: 1
              truthy:
                check-keys: false
              document-start: disable

  # Job 2: Build and validate Kustomize configurations
  kustomize-build:
    name: Kustomize Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main

      - name: Build clusters/production/infrastructure
        run: |
          echo "Building clusters/production/infrastructure..."
          kustomize build clusters/production/infrastructure/ > /tmp/infrastructure.yaml
          echo "Build successful - $(wc -l < /tmp/infrastructure.yaml) lines generated"

      - name: Build clusters/production/apps
        run: |
          echo "Building clusters/production/apps..."
          kustomize build clusters/production/apps/ > /tmp/apps.yaml
          echo "Build successful - $(wc -l < /tmp/apps.yaml) lines generated"

      - name: Build infrastructure-k8s/cilium
        run: |
          echo "Building infrastructure-k8s/cilium..."
          kustomize build infrastructure-k8s/cilium/ > /tmp/cilium.yaml
          echo "Build successful - $(wc -l < /tmp/cilium.yaml) lines generated"

      - name: Build infrastructure-k8s/storage
        run: |
          echo "Building infrastructure-k8s/storage..."
          kustomize build infrastructure-k8s/storage/ > /tmp/storage.yaml
          echo "Build successful - $(wc -l < /tmp/storage.yaml) lines generated"

  # Job 3: Validate Kubernetes manifests against schemas
  kubernetes-validate:
    name: Kubernetes Validation
    runs-on: ubuntu-latest
    needs: kustomize-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | \
            tar xz -C /usr/local/bin

      - name: Download Flux CRD schemas
        run: |
          mkdir -p /tmp/flux-schemas
          curl -sL https://github.com/fluxcd/flux2/releases/latest/download/crd-schemas.tar.gz | \
            tar xz -C /tmp/flux-schemas

      - name: Validate infrastructure manifests
        run: |
          echo "Validating infrastructure manifests..."
          kustomize build clusters/production/infrastructure/ | \
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -schema-location default \
              -schema-location '/tmp/flux-schemas/{{ .ResourceKind }}_{{ .ResourceAPIVersion }}.json' \
              -summary

      - name: Validate apps manifests
        run: |
          echo "Validating apps manifests..."
          kustomize build clusters/production/apps/ | \
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -schema-location default \
              -schema-location '/tmp/flux-schemas/{{ .ResourceKind }}_{{ .ResourceAPIVersion }}.json' \
              -summary

      - name: Validate Cilium manifests
        run: |
          echo "Validating Cilium manifests..."
          kustomize build infrastructure-k8s/cilium/ | \
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -summary

      - name: Validate storage manifests
        run: |
          echo "Validating storage manifests..."
          kustomize build infrastructure-k8s/storage/ | \
            kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -summary

  # Job 4: Validate Flux-specific resources
  flux-validate:
    name: Flux Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Validate Flux prerequisites
        run: flux check --pre

      - name: Validate Flux Kustomization resources
        run: |
          echo "Validating Flux Kustomization resources..."
          for file in $(find clusters/ -name '*.yaml' -type f); do
            if grep -q 'kind: Kustomization' "$file" && grep -q 'kustomize.toolkit.fluxcd.io' "$file"; then
              echo "Validating: $file"
              # Basic YAML validation
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            fi
          done
          echo "All Flux Kustomization resources are valid"

      - name: Validate HelmRelease resources
        run: |
          echo "Validating HelmRelease resources..."
          for file in $(find clusters/ -name '*helmrelease*.yaml' -type f); do
            echo "Validating: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "All HelmRelease resources are valid"

      - name: Validate HelmRepository resources
        run: |
          echo "Validating HelmRepository resources..."
          for file in $(find clusters/ -name '*helmrepo*.yaml' -type f); do
            echo "Validating: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "All HelmRepository resources are valid"

  # Job 5: Security scanning (optional but recommended)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          trivy-config: |
            severity: HIGH,CRITICAL
            exit-code: 0
          format: 'table'

      - name: Check for secrets in manifests
        run: |
          echo "Checking for potential secrets in manifests..."
          # Check for base64 encoded data that might be secrets
          if grep -rE 'password|secret|token|key' --include='*.yaml' clusters/ apps/ infrastructure-k8s/ | \
             grep -vE '(secretRef|secretKeyRef|valuesKey|existingSecret|secretName|#)'; then
            echo "Warning: Found potential secrets in manifests. Please review."
          else
            echo "No obvious secrets found in manifests"
          fi

name: GUI Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - "app/gui/**"
      - ".github/workflows/gui-deploy.yml"
      - "AGENTS.md"
  push:
    branches: [main]
    paths:
      - "app/gui/**"
      - ".github/workflows/gui-deploy.yml"
      - "AGENTS.md"
  workflow_dispatch:

jobs:
  validate:
    name: Validate GUI Build
    if: ${{ github.event_name != 'pull_request' || github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Enforce Bun-only lockfiles
        run: |
          set -euo pipefail
          forbidden_lockfiles=$(
            find . \
              -path "./node_modules" -prune -o \
              -path "./dist" -prune -o \
              -type f \( -name "package-lock.json" -o -name "yarn.lock" -o -name "pnpm-lock.yaml" \) \
              -print
          )
          if [ -n "$forbidden_lockfiles" ]; then
            echo "Forbidden lockfiles found in app/gui:"
            echo "$forbidden_lockfiles"
            exit 1
          fi

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

  deploy_preview:
    name: Deploy PR Preview
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && github.event.pull_request.head.repo.full_name == github.repository }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    concurrency:
      group: gui-preview-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install cuenv
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/cuenv" "https://github.com/cuenv/cuenv/releases/download/0.26.12/cuenv-linux-x64"
          chmod +x "$HOME/.local/bin/cuenv"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          "$HOME/.local/bin/cuenv" --version

      - name: Deploy preview worker via cuenv pipeline
        id: deploy
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          log_file="$(mktemp)"
          cuenv exec --path . --env production \
            bun x wrangler deploy --config wrangler.jsonc --name "waddle-gui-pr-${PR_NUMBER}" \
            2>&1 | tee "$log_file"
          preview_url="$(grep -Eo 'https://[A-Za-z0-9.-]+\\.workers\\.dev' "$log_file" | head -n1 || true)"
          if [ -n "$preview_url" ]; then
            echo "deployment-url=$preview_url" >> "$GITHUB_OUTPUT"
          fi

      - name: Post or update preview comment
        if: always()
        uses: actions/github-script@v7
        env:
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
          PREVIEW_URL: ${{ steps.deploy.outputs.deployment-url }}
          PREVIEW_WORKER: waddle-gui-pr-${{ github.event.pull_request.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const marker = '<!-- waddle-gui-preview -->';
            const deployOutcome = process.env.DEPLOY_OUTCOME || 'unknown';
            const previewUrl = process.env.PREVIEW_URL || '(deployment URL not reported by action output)';
            const workerName = process.env.PREVIEW_WORKER;
            const runUrl = process.env.RUN_URL;
            const body = deployOutcome === 'success'
              ? [
                  marker,
                  'ðŸš€ GUI preview deployed',
                  '',
                  `URL: ${previewUrl}`,
                  `Worker: \`${workerName}\``,
                ].join('\n')
              : [
                  marker,
                  'âš ï¸ GUI preview deploy failed',
                  '',
                  `Worker: \`${workerName}\``,
                  `Outcome: \`${deployOutcome}\``,
                  `Logs: ${runUrl}`,
                ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });
            const existing = comments.find((comment) => {
              return comment.user?.type === 'Bot' && comment.body?.includes(marker);
            });

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

      - name: Fail preview job if deployment failed
        if: ${{ steps.deploy.outcome != 'success' }}
        run: exit 1

  cleanup_preview:
    name: Cleanup PR Preview
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    concurrency:
      group: gui-preview-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install cuenv
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/cuenv" "https://github.com/cuenv/cuenv/releases/download/0.26.12/cuenv-linux-x64"
          chmod +x "$HOME/.local/bin/cuenv"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          "$HOME/.local/bin/cuenv" --version

      - name: Delete preview worker via cuenv
        id: cleanup
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: cuenv exec --path . --env production bun x wrangler delete --config wrangler.jsonc --name "waddle-gui-pr-${PR_NUMBER}" --force

      - name: Update preview comment
        uses: actions/github-script@v7
        env:
          PREVIEW_WORKER: waddle-gui-pr-${{ github.event.pull_request.number }}
        with:
          script: |
            const marker = '<!-- waddle-gui-preview -->';
            const workerName = process.env.PREVIEW_WORKER;
            const body = [
              marker,
              'ðŸ§¹ GUI preview cleaned up',
              '',
              `Worker: \`${workerName}\``,
              'Status: deleted on PR close.',
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });
            const existing = comments.find((comment) => {
              return comment.user?.type === 'Bot' && comment.body?.includes(marker);
            });

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

  deploy_production:
    name: Deploy Production
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: gui-production-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install cuenv
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/cuenv" "https://github.com/cuenv/cuenv/releases/download/0.26.12/cuenv-linux-x64"
          chmod +x "$HOME/.local/bin/cuenv"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          "$HOME/.local/bin/cuenv" --version

      - name: Deploy production via cuenv pipeline
        run: cuenv exec --path . --env production bun x wrangler deploy --config wrangler.jsonc --env production

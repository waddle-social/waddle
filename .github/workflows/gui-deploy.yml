name: GUI Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - "app/gui/**"
      - ".github/workflows/gui-deploy.yml"
      - "AGENTS.md"
  push:
    branches: [main]
    paths:
      - "app/gui/**"
      - ".github/workflows/gui-deploy.yml"
      - "AGENTS.md"
  workflow_dispatch:

jobs:
  validate:
    name: Validate GUI Build
    if: ${{ github.event_name != 'pull_request' || github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Enforce Bun-only lockfiles
        run: |
          set -euo pipefail
          forbidden_lockfiles=$(
            find . \
              -path "./node_modules" -prune -o \
              -path "./dist" -prune -o \
              -type f \( -name "package-lock.json" -o -name "yarn.lock" -o -name "pnpm-lock.yaml" \) \
              -print
          )
          if [ -n "$forbidden_lockfiles" ]; then
            echo "Forbidden lockfiles found in app/gui:"
            echo "$forbidden_lockfiles"
            exit 1
          fi

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

  deploy_preview:
    name: Deploy PR Preview
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && github.event.pull_request.head.repo.full_name == github.repository }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    concurrency:
      group: gui-preview-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Deploy preview worker
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: app/gui
          command: deploy --config wrangler.jsonc --name waddle-gui-pr-${{ github.event.pull_request.number }}

      - name: Post or update preview comment
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.deploy.outputs.deployment-url }}
          PREVIEW_WORKER: waddle-gui-pr-${{ github.event.pull_request.number }}
        with:
          script: |
            const marker = '<!-- waddle-gui-preview -->';
            const previewUrl = process.env.PREVIEW_URL || '(deployment URL not reported by action output)';
            const workerName = process.env.PREVIEW_WORKER;
            const body = [
              marker,
              'ðŸš€ GUI preview deployed',
              '',
              `URL: ${previewUrl}`,
              `Worker: \`${workerName}\``,
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });
            const existing = comments.find((comment) => {
              return comment.user?.type === 'Bot' && comment.body?.includes(marker);
            });

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

  cleanup_preview:
    name: Cleanup PR Preview
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    concurrency:
      group: gui-preview-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete preview worker
        id: cleanup
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: app/gui
          command: delete --config wrangler.jsonc --name waddle-gui-pr-${{ github.event.pull_request.number }} --force

      - name: Update preview comment
        uses: actions/github-script@v7
        env:
          PREVIEW_WORKER: waddle-gui-pr-${{ github.event.pull_request.number }}
        with:
          script: |
            const marker = '<!-- waddle-gui-preview -->';
            const workerName = process.env.PREVIEW_WORKER;
            const body = [
              marker,
              'ðŸ§¹ GUI preview cleaned up',
              '',
              `Worker: \`${workerName}\``,
              'Status: deleted on PR close.',
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });
            const existing = comments.find((comment) => {
              return comment.user?.type === 'Bot' && comment.body?.includes(marker);
            });

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

  deploy_production:
    name: Deploy Production
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: gui-production-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: app/gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Deploy production worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: app/gui
          command: deploy --config wrangler.jsonc --env production
